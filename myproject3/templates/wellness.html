<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wellness Tracker - VetTrack Ai</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <style>
        .food-manager-shell {
            background:
                radial-gradient(circle at 12% 16%, rgba(37, 99, 235, .14) 0%, rgba(37, 99, 235, 0) 36%),
                radial-gradient(circle at 86% 84%, rgba(34, 197, 94, .15) 0%, rgba(34, 197, 94, 0) 38%),
                linear-gradient(180deg, #f8fbff 0%, #f5fbf7 100%);
            border: 1px solid #cfe0f2;
            border-radius: 18px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 14px 34px rgba(15, 39, 71, .09);
        }
        .food-manager-shell::before {
            content: "";
            position: absolute;
            top: -70px;
            right: -70px;
            width: 180px;
            height: 180px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(59, 130, 246, .15) 0%, rgba(59, 130, 246, 0) 70%);
            pointer-events: none;
        }
        .food-manager-shell::after {
            content: "";
            position: absolute;
            bottom: -80px;
            left: -80px;
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(34, 197, 94, .12) 0%, rgba(34, 197, 94, 0) 70%);
            pointer-events: none;
        }
        .food-hero {
            position: relative;
            z-index: 1;
            border: 1px solid rgba(255, 255, 255, .32);
            border-radius: 16px;
            padding: .9rem 1rem;
            background: linear-gradient(108deg, #1d4ed8 0%, #0ea5e9 52%, #22c55e 100%);
            margin-bottom: 1rem;
            box-shadow: 0 14px 30px rgba(14, 116, 144, .25);
        }
        .food-hero .fw-bold,
        .food-hero small {
            color: #fff !important;
        }
        .mode-toggle {
            border: 1px solid rgba(255, 255, 255, .25);
            border-radius: 12px;
            padding: 4px;
            background: rgba(255, 255, 255, .18);
            backdrop-filter: blur(6px);
            display: inline-flex;
            gap: 6px;
        }
        .mode-toggle .btn {
            border-radius: 9px;
            border: none;
            font-size: .8rem;
            font-weight: 700;
            color: #64748b;
            padding: .35rem .8rem;
        }
        .mode-toggle .btn.active {
            background: #ffffff;
            color: #0f172a;
            box-shadow: 0 8px 18px rgba(15, 23, 42, .2);
        }
        .food-section-title {
            letter-spacing: .2px;
            font-size: .83rem;
            font-weight: 700;
            color: #64748b;
            text-transform: uppercase;
        }
        .food-card {
            border: 1px solid #dfeaf5;
            border-radius: 16px;
            background: #ffffff;
            padding: 14px;
            height: auto;
            box-shadow: 0 6px 18px rgba(15, 39, 71, .05);
            transition: transform .2s ease, box-shadow .2s ease, border-color .2s ease;
        }
        .food-metric-card {
            min-height: 116px;
        }
        .food-card:hover {
            transform: translateY(-2px);
            border-color: #c9ddf0;
            box-shadow: 0 10px 24px rgba(15, 39, 71, .08);
        }
        .food-card.soft-blue {
            background: linear-gradient(180deg, #eaf4ff 0%, #e3f0ff 100%);
        }
        .food-card.soft-green {
            background: linear-gradient(180deg, #ecfff1 0%, #e4fbed 100%);
        }
        .food-card.soft-amber {
            background: linear-gradient(180deg, #fff8ec 0%, #fff2da 100%);
        }
        .food-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border: 1px solid #e2e8f0;
            border-radius: 999px;
            background: #f8fafc;
            color: #475569;
            padding: 5px 10px;
            font-size: .78rem;
            margin: 0 6px 6px 0;
        }
        .food-item-btn {
            width: 100%;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: .65rem .85rem;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: .65rem;
            transition: all .2s ease;
        }
        .food-item-btn:hover {
            background: #f8fafc;
        }
        .food-item-btn.marked {
            border-color: #86efac;
            background: #f0fdf4;
            color: #166534;
        }
        .food-logo {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: #2563eb;
            background: #fff;
            margin-right: 8px;
        }
        .food-actions {
            display: flex;
            gap: 6px;
            align-items: center;
        }
        .meal-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: .8rem;
        }
        .meal-card {
            border: 1px solid #e2e8f0;
            border-radius: 14px;
            padding: .9rem;
            background: linear-gradient(180deg, #ffffff 0%, #f9fbff 100%);
            transition: all .2s ease;
        }
        .meal-card:hover {
            border-color: #c9ddf0;
            box-shadow: 0 8px 18px rgba(15, 39, 71, .08);
        }
        .meal-card.marked {
            border-color: #34d399;
            background: linear-gradient(180deg, #effff4 0%, #e7fff1 100%);
            box-shadow: 0 6px 14px rgba(22, 101, 52, .08);
        }
        .meal-meta {
            display: flex;
            gap: .35rem;
            flex-wrap: wrap;
            margin-top: .45rem;
        }
        .meal-meta .badge {
            font-weight: 600;
            border: 1px solid #e2e8f0;
            background: #f8fafc !important;
            color: #334155 !important;
        }
        .meal-meta .badge:nth-child(2) {
            background: #eefdf3 !important;
            color: #166534 !important;
            border-color: #c8f0d7;
        }
        .meal-meta .badge:nth-child(3) {
            background: #eef8ff !important;
            color: #0f4c81 !important;
            border-color: #cde5f7;
        }
        .meal-meta .badge:nth-child(4) {
            background: #fff7ea !important;
            color: #92400e !important;
            border-color: #f5ddbe;
        }
        .food-actions .btn {
            border-radius: 10px;
            min-width: 34px;
        }
        .food-actions .btn-outline-success {
            border-color: #86efac;
            color: #15803d;
            background: #f0fdf4;
        }
        .food-actions .btn-outline-primary {
            border-color: #93c5fd;
            color: #1d4ed8;
            background: #eff6ff;
        }
        .food-actions .btn-outline-danger {
            border-color: #fda4af;
            color: #be123c;
            background: #fff1f2;
        }
        .food-plan-input {
            border-radius: 10px;
            border-color: #d6e2ee;
            background: #fcfdff;
        }
        .food-plan-input:focus {
            border-color: #93c5fd;
            box-shadow: 0 0 0 .2rem rgba(37, 99, 235, .12);
        }
        .ring-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: .6rem;
            margin-top: .6rem;
            margin-bottom: .55rem;
        }
        .macro-ring {
            background: #fff;
            border: 1px solid #deebf6;
            border-radius: 12px;
            padding: .55rem .35rem;
            text-align: center;
        }
        .macro-ring-track {
            --ringColor: #2563eb;
            --ringValue: 0deg;
            width: 54px;
            height: 54px;
            border-radius: 999px;
            margin: 0 auto .4rem;
            background:
                radial-gradient(closest-side, #fff 74%, transparent 75% 100%),
                conic-gradient(var(--ringColor) var(--ringValue), #e2e8f0 0);
            display: grid;
            place-items: center;
            font-size: .72rem;
            font-weight: 800;
            color: #0f172a;
        }
        .macro-ring small {
            font-size: .72rem;
            color: #64748b;
        }
        .macro-graph {
            border: 1px solid #deebf6;
            border-radius: 14px;
            padding: .75rem;
            background: linear-gradient(180deg, #ffffff 0%, #f8fbff 100%);
            min-height: 210px;
        }
        .macro-canvas-wrap {
            border: 1px solid #dbe8f5;
            border-radius: 12px;
            background: linear-gradient(180deg, #ffffff 0%, #f3f9ff 100%);
            padding: .4rem;
            margin-top: .55rem;
        }
        .macro-graph-row {
            margin-bottom: .7rem;
        }
        .macro-graph-row:last-child {
            margin-bottom: 0;
        }
        .macro-graph-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: .78rem;
            color: #475569;
            margin-bottom: .25rem;
        }
        .bar-track {
            height: 8px;
            border-radius: 999px;
            background: #e5edf6;
            overflow: hidden;
            position: relative;
        }
        .bar-selected {
            height: 100%;
            border-radius: 999px;
            transition: width .35s ease;
            background: linear-gradient(90deg, #22c55e 0%, #16a34a 100%);
        }
        #fpScoreBar {
            background: linear-gradient(90deg, #2563eb 0%, #06b6d4 55%, #22c55e 100%);
        }
        .bar-target {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #0f172a;
            opacity: .75;
        }
        .graph-legend {
            display: flex;
            gap: .8rem;
            font-size: .72rem;
            color: #64748b;
            margin-top: .45rem;
        }
        .graph-dot {
            width: 8px;
            height: 8px;
            border-radius: 999px;
            display: inline-block;
            margin-right: 4px;
        }
        .calendar-theme-card {
            border: 1px solid #cfe0f2;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 10px 24px rgba(15, 39, 71, .08);
        }
        .calendar-theme-head {
            background: linear-gradient(105deg, #1d4ed8 0%, #0ea5e9 55%, #22c55e 100%);
            color: #fff;
            border-bottom: none;
        }
        .calendar-theme-head h6 {
            color: #fff;
            font-weight: 700;
        }
        .mini-cal-wrap {
            border: 1px solid #dbe8f5;
            border-radius: 14px;
            background: linear-gradient(180deg, #ffffff 0%, #f4f9ff 100%);
            padding: .7rem .6rem .55rem;
        }
        .mini-cal-month {
            text-align: center;
            font-weight: 800;
            color: #0f172a;
            margin-bottom: .35rem;
        }
        .mini-cal-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 6px;
            font-size: .82rem;
        }
        .mini-cal-table th {
            font-size: .72rem;
            color: #64748b;
            font-weight: 700;
            text-align: center;
            padding-bottom: .15rem;
        }
        .mini-cal-table td {
            text-align: center;
            vertical-align: top;
            width: 14.2%;
        }
        .mini-cal-day {
            width: 30px;
            height: 30px;
            border-radius: 10px;
            display: grid;
            place-items: center;
            margin: 0 auto;
            color: #1e293b;
            font-weight: 600;
            transition: all .18s ease;
            border: 1px solid transparent;
        }
        .mini-cal-day:hover {
            background: #eaf4ff;
            border-color: #bfdbfe;
        }
        .mini-cal-day.today {
            background: linear-gradient(135deg, #2563eb 0%, #06b6d4 100%);
            color: #fff;
            box-shadow: 0 8px 16px rgba(37, 99, 235, .3);
        }
        .mini-cal-dots {
            display: flex;
            justify-content: center;
            gap: 4px;
            margin-top: 2px;
            min-height: 6px;
        }
        .mini-dot {
            width: 5px;
            height: 5px;
            border-radius: 999px;
        }
        .mini-dot.history { background: #10b981; }
        .mini-dot.reminder { background: #f59e0b; }
        .mini-cal-legend {
            margin-top: .45rem;
            display: flex;
            justify-content: center;
            gap: .8rem;
            font-size: .75rem;
            color: #64748b;
        }
    </style>
</head>

<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('index') }}">
                <i class="fas fa-paw text-primary me-2"></i>
                <strong>VetTrack Ai</strong>
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('dashboard') }}">
                    <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <!-- Main Content -->
            <div class="col-lg-8">
                <!-- Header -->
                <div class="card shadow-sm mb-4">
                    <div class="card-body text-center">
                        <i class="fas fa-calendar-heart text-success display-4 mb-3"></i>
                        <h1 class="h2 fw-bold">Wellness Tracker</h1>
                        <p class="text-muted">Keep track of your pet's preventive care schedule and health milestones</p>
                    </div>
                </div>

                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-bowl-food me-2"></i>Animal Food Plan Manager</h5>
                    </div>
                    <div class="card-body food-manager-shell">
                        <div class="food-hero d-flex flex-wrap justify-content-between align-items-center gap-2">
                            <div>
                                <div class="fw-bold text-dark"><i class="fas fa-sparkles text-primary me-1"></i>Smart Food Planner</div>
                                <small class="text-muted">Track selected meals and compare intake vs target macros.</small>
                            </div>
                            <div class="mode-toggle">
                                <button id="fpModeDaily" class="btn active" type="button" onclick="setFoodViewMode('daily')">Today</button>
                                <button id="fpModeWeekly" class="btn" type="button" onclick="setFoodViewMode('weekly')">Weekly</button>
                            </div>
                        </div>
                        <div class="row g-3 mb-3">
                            <div class="col-md-3">
                                <label class="form-label">Animal type</label>
                                <select id="fpAnimalType" class="form-select food-plan-input">
                                    <option value="Dog">Dog</option>
                                    <option value="Cat">Cat</option>
                                    <option value="Rabbit">Rabbit</option>
                                    <option value="Bird">Bird</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Age (years)</label>
                                <input id="fpAge" type="number" class="form-control food-plan-input" value="3" min="0.5" step="0.5">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Current weight (kg)</label>
                                <input id="fpCurrentWeight" type="number" class="form-control food-plan-input" value="20" min="0.5" step="0.1">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Target weight (kg)</label>
                                <input id="fpTargetWeight" type="number" class="form-control food-plan-input" value="18" min="0" step="0.1">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Activity level</label>
                                <select id="fpActivityLevel" class="form-select food-plan-input">
                                    <option value="low">Low</option>
                                    <option value="moderate" selected>Moderate</option>
                                    <option value="high">High</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Fitness goal</label>
                                <select id="fpFitnessGoal" class="form-select food-plan-input">
                                    <option value="Weight Loss">Weight Loss</option>
                                    <option value="Weight Gain">Weight Gain</option>
                                    <option value="Maintenance">Maintenance</option>
                                    <option value="Muscle Building">Muscle Building</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Diet duration (weeks)</label>
                                <input id="fpDurationWeeks" type="number" class="form-control food-plan-input" value="8" min="1" max="52">
                            </div>
                        </div>

                        <div class="row g-3 mb-3">
                            <div class="col-md-4">
                                <div class="food-card food-metric-card soft-blue">
                                    <div class="food-section-title"><i class="fas fa-fire me-1"></i>Total daily calories</div>
                                    <div class="h5 mb-1 mt-1" id="fpCalories">0 kcal</div>
                                    <small class="text-muted" id="fpMaintenance">Maintenance: 0 kcal</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="food-card food-metric-card soft-green">
                                    <div class="food-section-title"><i class="fas fa-chart-pie me-1"></i>Macro breakdown</div>
                                    <div class="small mt-1" id="fpProtein">Protein: 0 g/day</div>
                                    <div class="small" id="fpFats">Fats: 0 g/day</div>
                                    <div class="small" id="fpCarbs">Carbs: 0 g/day</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="food-card food-metric-card soft-amber">
                                    <div class="food-section-title"><i class="fas fa-droplet me-1"></i>Hydration & feeding</div>
                                    <div class="small mt-1" id="fpFeeding">Feeding: 0 meals/day</div>
                                    <div class="small" id="fpWater">Water: 0 ml/day</div>
                                    <div class="small" id="fpWeeklyDelta">Weekly change: 0 kg/week</div>
                                </div>
                            </div>
                        </div>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="food-card">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div class="small fw-semibold text-muted"><i class="fas fa-utensils me-1"></i>Suggested foods</div>
                                        <span class="badge text-bg-success" id="fpMarkedCount">0/0 marked</span>
                                    </div>
                                    <div class="input-group input-group-sm mb-2">
                                        <input id="fpNewFoodInput" type="text" class="form-control" placeholder="Add custom food">
                                        <button class="btn btn-outline-primary" type="button" onclick="addFoodItem()">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                        <button class="btn btn-outline-secondary" type="button" onclick="clearFoodMarks()">
                                            Unmark All
                                        </button>
                                    </div>
                                    <div id="fpFoodsContainer" class="meal-grid"></div>
                                </div>
                            </div>
                            <div class="col-md-6 d-flex flex-column gap-3">
                                <div class="food-card">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="small fw-semibold text-muted"><i class="fas fa-trophy me-1"></i>Food Plan Score</div>
                                        <span class="badge text-bg-primary" id="fpScoreText">0%</span>
                                    </div>
                                    <div class="progress mt-2" style="height: 8px;">
                                        <div id="fpScoreBar" class="progress-bar bg-primary" role="progressbar" style="width: 0%"></div>
                                    </div>
                                    <small class="text-muted">Score updates when you click and mark foods.</small>

                                    <div class="macro-canvas-wrap">
                                        <canvas id="fpMacroCanvas" height="180"></canvas>
                                    </div>
                                </div>
                                <div class="food-card">
                                    <div class="small fw-semibold text-muted mb-2"><i class="fas fa-bolt me-1"></i>Selected Intake (Marked Foods)</div>
                                    <div class="small" id="fpSelectedCalories">Calories: 0 kcal</div>
                                    <div class="small" id="fpSelectedProtein">Protein: 0 g</div>
                                    <div class="small" id="fpSelectedCarbs">Carbs: 0 g</div>
                                    <div class="small" id="fpSelectedFats">Fats: 0 g</div>
                                    <div class="ring-grid">
                                        <div class="macro-ring">
                                            <div id="fpProteinRing" class="macro-ring-track" style="--ringColor:#16a34a;--ringValue:0deg;">0%</div>
                                            <small>Protein</small>
                                        </div>
                                        <div class="macro-ring">
                                            <div id="fpCarbsRing" class="macro-ring-track" style="--ringColor:#0ea5e9;--ringValue:0deg;">0%</div>
                                            <small>Carbs</small>
                                        </div>
                                        <div class="macro-ring">
                                            <div id="fpFatsRing" class="macro-ring-track" style="--ringColor:#f59e0b;--ringValue:0deg;">0%</div>
                                            <small>Fats</small>
                                        </div>
                                    </div>
                                    <div class="progress mt-2 mb-1" style="height: 7px;">
                                        <div id="fpProteinProgress" class="progress-bar bg-success" style="width: 0%"></div>
                                    </div>
                                    <small class="text-muted" id="fpProteinProgressText">Protein target progress: 0%</small>
                                    <div class="progress mt-2 mb-1" style="height: 7px;">
                                        <div id="fpCarbsProgress" class="progress-bar bg-info" style="width: 0%"></div>
                                    </div>
                                    <small class="text-muted" id="fpCarbsProgressText">Carbs target progress: 0%</small>
                                </div>
                                <div class="food-card">
                                    <div class="small fw-semibold text-muted mb-2"><i class="fas fa-capsules me-1"></i>Important micronutrients</div>
                                    <div id="fpMicronutrients"></div>
                                </div>
                                <div class="food-card">
                                    <div class="small fw-semibold text-muted mb-2"><i class="fas fa-chart-column me-1"></i>Macro Comparison Graph</div>
                                    <div class="macro-graph">
                                        <div class="macro-graph-row">
                                            <div class="macro-graph-label">
                                                <span>Protein</span>
                                                <span id="fpGraphProteinText">0 / 0 g</span>
                                            </div>
                                            <div class="bar-track">
                                                <div id="fpGraphProteinBar" class="bar-selected" style="width: 0%"></div>
                                                <span class="bar-target" style="left: 100%"></span>
                                            </div>
                                        </div>
                                        <div class="macro-graph-row">
                                            <div class="macro-graph-label">
                                                <span>Carbs</span>
                                                <span id="fpGraphCarbsText">0 / 0 g</span>
                                            </div>
                                            <div class="bar-track">
                                                <div id="fpGraphCarbsBar" class="bar-selected" style="width: 0%; background: linear-gradient(90deg, #38bdf8 0%, #0284c7 100%);"></div>
                                                <span class="bar-target" style="left: 100%"></span>
                                            </div>
                                        </div>
                                        <div class="macro-graph-row">
                                            <div class="macro-graph-label">
                                                <span>Fats</span>
                                                <span id="fpGraphFatsText">0 / 0 g</span>
                                            </div>
                                            <div class="bar-track">
                                                <div id="fpGraphFatsBar" class="bar-selected" style="width: 0%; background: linear-gradient(90deg, #fbbf24 0%, #d97706 100%);"></div>
                                                <span class="bar-target" style="left: 100%"></span>
                                            </div>
                                        </div>
                                        <div class="graph-legend">
                                            <span><i class="graph-dot" style="background:#16a34a;"></i>Selected intake</span>
                                            <span><i class="graph-dot" style="background:#0f172a;"></i>Target marker</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="food-card">
                                    <div class="small fw-semibold text-muted mb-2"><i class="fas fa-robot me-1"></i>AI Summary</div>
                                    <small id="fpAiSummary" class="text-muted"></small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="row mb-4">
                    <div class="col-md-4 mb-3">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-body text-center">
                                <i class="fas fa-syringe text-primary display-6 mb-3"></i>
                                <h5>Vaccination</h5>
                                <button class="btn btn-primary btn-sm" onclick="addReminder('vaccination')">
                                    <i class="fas fa-plus me-1"></i>Schedule
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-body text-center">
                                <i class="fas fa-cut text-info display-6 mb-3"></i>
                                <h5>Grooming</h5>
                                <button class="btn btn-info btn-sm" onclick="addReminder('grooming')">
                                    <i class="fas fa-plus me-1"></i>Schedule
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-body text-center">
                                <i class="fas fa-stethoscope text-success display-6 mb-3"></i>
                                <h5>Checkup</h5>
                                <button class="btn btn-success btn-sm" onclick="addReminder('checkup')">
                                    <i class="fas fa-plus me-1"></i>Schedule
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Upcoming Reminders -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Upcoming Reminders</h5>
                        <div>
                            <button class="btn btn-warning btn-sm me-2" onclick="announceRemindersManually()" id="wellnessAnnounceBtn" style="display: none;">
                                <i class="fas fa-volume-up me-1"></i>Announce
                            </button>
                            <button class="btn btn-light btn-sm" onclick="showAddReminderModal()">
                                <i class="fas fa-plus me-1"></i>Add Reminder
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div id="remindersContainer">
                            <!-- Reminders will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Health Insights -->
                <div class="card shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Health Insights</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 text-center mb-3">
                                <div class="d-flex align-items-center justify-content-center mb-2">
                                    <i class="fas fa-heart text-success me-2"></i>
                                    <h6>Last Checkup</h6>
                                </div>
                                <p class="text-muted" id="lastCheckupText">Never</p>
                            </div>
                            <div class="col-md-4 text-center mb-3">
                                <div class="d-flex align-items-center justify-content-center mb-2">
                                    <i class="fas fa-syringe text-info me-2"></i>
                                    <h6>Vaccination Status</h6>
                                </div>
                                <p class="text-muted" id="vaccinationStatusText">Up to date</p>
                            </div>
                            <div class="col-md-4 text-center mb-3">
                                <div class="d-flex align-items-center justify-content-center mb-2">
                                    <i class="fas fa-chart-bar text-warning me-2"></i>
                                    <h6>Wellness Score</h6>
                                </div>
                                <div class="progress mb-2" style="height: 8px;">
                                    <div class="progress-bar bg-success" role="progressbar" style="width: 85%" id="wellnessProgress"></div>
                                </div>
                                <small class="text-muted" id="wellnessScoreText">85% - Based on preventive care compliance</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Pet Selector -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header">
                        <h6 class="mb-0">Select Pet</h6>
                    </div>
                    <div class="card-body">
                        <select class="form-select" id="petSelect" onchange="loadWellnessData()">
                            <option value="">All Pets</option>
                        </select>
                    </div>
                </div>

                <!-- Calendar Widget -->
                <div class="card shadow-sm mb-4 calendar-theme-card">
                    <div class="card-header calendar-theme-head">
                        <h6 class="mb-0"><i class="fas fa-calendar me-2"></i>This Month</h6>
                    </div>
                    <div class="card-body">
                        <div id="miniCalendar">
                            <!-- Simple calendar will be rendered here -->
                        </div>
                    </div>
                </div>

                <!-- Quick Tips -->
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Wellness Tips</h6>
                    </div>
                    <div class="card-body">
                        <div class="d-flex align-items-start mb-3">
                            <i class="fas fa-water text-info me-2 mt-1"></i>
                            <small>Ensure fresh water is always available</small>
                        </div>
                        <div class="d-flex align-items-start mb-3">
                            <i class="fas fa-running text-success me-2 mt-1"></i>
                            <small>Regular exercise keeps pets healthy and happy</small>
                        </div>
                        <div class="d-flex align-items-start">
                            <i class="fas fa-tooth text-warning me-2 mt-1"></i>
                            <small>Brush your pet's teeth regularly</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Reminder Modal -->
    <div class="modal fade" id="addReminderModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Wellness Reminder</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="reminderForm">
                        <div class="mb-3">
                            <label for="reminderPet" class="form-label">Select Pet</label>
                            <select class="form-select" id="reminderPet" required>
                                <option value="">Choose your pet...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="reminderType" class="form-label">Reminder Type</label>
                            <select class="form-select" id="reminderType" required>
                                <option value="">Select type...</option>
                                <option value="vaccination">Vaccination</option>
                                <option value="grooming">Grooming</option>
                                <option value="checkup">Vet Checkup</option>
                                <option value="medication">Medication</option>
                                <option value="flea_treatment">Flea Treatment</option>
                                <option value="deworming">Deworming</option>
                                <option value="nail_trimming">Nail Trimming</option>
                                <option value="dental_care">Dental Care</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="reminderTitle" class="form-label">Title</label>
                            <input type="text" class="form-control" id="reminderTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="reminderDate" class="form-label">Due Date</label>
                            <input type="datetime-local" class="form-control" id="reminderDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="reminderNotes" class="form-label">Notes (Optional)</label>
                            <textarea class="form-control" id="reminderNotes" rows="3" placeholder="Additional notes or instructions..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveReminder()">Save Reminder</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    <script>
        // Flag to prevent multiple announcements
        let hasAnnouncedReminders = false;
        let markedFoods = [];
        let foodPlanFoodsByAnimal = {};
        let currentFoodMacroTargets = { protein: 0, carbs: 0, fats: 0 };
        let fpViewMode = 'daily';

        const fpActivityFactors = { low: 1.2, moderate: 1.4, high: 1.7 };
        const fpGoalAdjustments = { 'Weight Loss': 0.85, 'Weight Gain': 1.15, 'Maintenance': 1, 'Muscle Building': 1.1 };
        const fpMacroProfiles = {
            'Weight Loss': { protein: 0.35, fats: 0.30, carbs: 0.35 },
            'Weight Gain': { protein: 0.25, fats: 0.25, carbs: 0.50 },
            'Maintenance': { protein: 0.30, fats: 0.30, carbs: 0.40 },
            'Muscle Building': { protein: 0.40, fats: 0.25, carbs: 0.35 },
        };
        const fpFoodOptionsByAnimal = {
            Dog: [
                { name: 'Lean chicken breast', icon: 'fa-drumstick-bite', serving: '100g', calories: 165, protein: 31, carbs: 0, fats: 3.6 },
                { name: 'Brown rice', icon: 'fa-wheat-awn', serving: '120g cooked', calories: 135, protein: 2.8, carbs: 28, fats: 1 },
                { name: 'Pumpkin puree', icon: 'fa-carrot', serving: '100g', calories: 26, protein: 1, carbs: 6.5, fats: 0.1 },
                { name: 'Salmon oil', icon: 'fa-fish', serving: '1 tsp', calories: 40, protein: 0, carbs: 0, fats: 4.5 },
                { name: 'Carrots', icon: 'fa-carrot', serving: '100g', calories: 41, protein: 0.9, carbs: 10, fats: 0.2 },
                { name: 'Low-fat yogurt', icon: 'fa-jar', serving: '100g', calories: 63, protein: 5.5, carbs: 7, fats: 1.6 },
            ],
            Cat: [
                { name: 'Turkey thigh', icon: 'fa-drumstick-bite', serving: '100g', calories: 170, protein: 28, carbs: 0, fats: 6 },
                { name: 'Egg whites', icon: 'fa-egg', serving: '2 whites', calories: 34, protein: 7.2, carbs: 0.5, fats: 0.1 },
                { name: 'Pumpkin puree', icon: 'fa-carrot', serving: '80g', calories: 21, protein: 0.8, carbs: 5.2, fats: 0.1 },
                { name: 'Sardines in water', icon: 'fa-fish', serving: '60g', calories: 125, protein: 14.5, carbs: 0, fats: 7 },
                { name: 'Spinach', icon: 'fa-leaf', serving: '50g', calories: 12, protein: 1.5, carbs: 1.8, fats: 0.2 },
                { name: 'Bone broth', icon: 'fa-mug-hot', serving: '100ml', calories: 15, protein: 3, carbs: 0, fats: 0.2 },
            ],
            Rabbit: [
                { name: 'Timothy hay', icon: 'fa-wheat-awn', serving: '30g', calories: 75, protein: 3.6, carbs: 12, fats: 1 },
                { name: 'Romaine lettuce', icon: 'fa-leaf', serving: '100g', calories: 17, protein: 1.2, carbs: 3.3, fats: 0.3 },
                { name: 'Bell pepper', icon: 'fa-carrot', serving: '80g', calories: 20, protein: 0.7, carbs: 4.8, fats: 0.2 },
                { name: 'Parsley', icon: 'fa-leaf', serving: '30g', calories: 11, protein: 0.9, carbs: 1.9, fats: 0.2 },
                { name: 'Pellets (measured)', icon: 'fa-bowl-food', serving: '25g', calories: 90, protein: 4.5, carbs: 14, fats: 1.5 },
                { name: 'Cilantro', icon: 'fa-leaf', serving: '30g', calories: 7, protein: 0.6, carbs: 1.2, fats: 0.1 },
            ],
            Bird: [
                { name: 'High-quality pellets', icon: 'fa-bowl-food', serving: '20g', calories: 70, protein: 3.5, carbs: 10, fats: 2 },
                { name: 'Leafy greens', icon: 'fa-leaf', serving: '40g', calories: 12, protein: 1.2, carbs: 2, fats: 0.2 },
                { name: 'Cooked quinoa', icon: 'fa-wheat-awn', serving: '50g', calories: 60, protein: 2.2, carbs: 10.5, fats: 1 },
                { name: 'Carrot shreds', icon: 'fa-carrot', serving: '40g', calories: 16, protein: 0.4, carbs: 4, fats: 0.1 },
                { name: 'Apple slices', icon: 'fa-apple-whole', serving: '40g', calories: 21, protein: 0.1, carbs: 5.5, fats: 0.1 },
                { name: 'Millet (limited)', icon: 'fa-wheat-awn', serving: '15g', calories: 56, protein: 1.7, carbs: 11.1, fats: 0.6 },
            ]
        };
        const fpMicronutrientsByAnimal = {
            Dog: ['Omega-3', 'Calcium', 'Vitamin D', 'Zinc'],
            Cat: ['Taurine', 'Omega-3', 'Vitamin A', 'B-Complex'],
            Rabbit: ['Fiber', 'Calcium', 'Vitamin A', 'Manganese'],
            Bird: ['Vitamin A', 'Calcium', 'Iodine', 'Vitamin E']
        };

        // Reset flag when page is refreshed or navigated to
        window.addEventListener('beforeunload', function() {
            hasAnnouncedReminders = false;
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadPetsForWellness();
            loadReminders();
            loadWellnessInsights();
            generateMiniCalendar(); // Generate calendar on page load
            initFoodPlanManager();
        });

        function initFoodPlanManager() {
            foodPlanFoodsByAnimal = JSON.parse(JSON.stringify(fpFoodOptionsByAnimal));
            document.querySelectorAll('.food-plan-input').forEach(input => {
                input.addEventListener('input', calculateFoodPlan);
                input.addEventListener('change', calculateFoodPlan);
            });
            calculateFoodPlan();
        }

        function setFoodViewMode(mode) {
            fpViewMode = mode;
            document.getElementById('fpModeDaily').classList.toggle('active', mode === 'daily');
            document.getElementById('fpModeWeekly').classList.toggle('active', mode === 'weekly');
            updateSelectedNutrition();
        }

        function roundNumber(value) {
            return Math.round(value);
        }

        function calculateFoodPlan() {
            const animalType = document.getElementById('fpAnimalType').value;
            const age = parseFloat(document.getElementById('fpAge').value) || 0;
            const currentWeight = parseFloat(document.getElementById('fpCurrentWeight').value) || 0;
            const targetWeight = parseFloat(document.getElementById('fpTargetWeight').value) || 0;
            const activityLevel = document.getElementById('fpActivityLevel').value;
            const fitnessGoal = document.getElementById('fpFitnessGoal').value;
            const durationWeeks = parseFloat(document.getElementById('fpDurationWeeks').value) || 1;

            const baseRer = 70 * Math.pow(Math.max(currentWeight, 0.1), 0.75);
            const maintenanceCalories = baseRer * (fpActivityFactors[activityLevel] || 1.2);
            const adjustedCalories = maintenanceCalories * (fpGoalAdjustments[fitnessGoal] || 1);
            const profile = fpMacroProfiles[fitnessGoal] || fpMacroProfiles['Maintenance'];

            const proteinGrams = (adjustedCalories * profile.protein) / 4;
            const fatGrams = (adjustedCalories * profile.fats) / 9;
            const carbGrams = (adjustedCalories * profile.carbs) / 4;
            currentFoodMacroTargets = { protein: proteinGrams, carbs: carbGrams, fats: fatGrams };
            const mealsPerDay = animalType === 'Cat' ? 3 : 2;
            const waterMl = currentWeight * 55;
            const weeklyDelta = durationWeeks > 0 ? ((targetWeight - currentWeight) / durationWeeks) : 0;

            const foods = foodPlanFoodsByAnimal[animalType] || foodPlanFoodsByAnimal.Dog || [];
            const micronutrients = fpMicronutrientsByAnimal[animalType] || fpMicronutrientsByAnimal.Dog;

            document.getElementById('fpCalories').textContent = `${roundNumber(adjustedCalories)} kcal`;
            document.getElementById('fpMaintenance').textContent = `Maintenance: ${roundNumber(maintenanceCalories)} kcal`;
            document.getElementById('fpProtein').textContent = `Protein: ${roundNumber(proteinGrams)} g/day`;
            document.getElementById('fpFats').textContent = `Fats: ${roundNumber(fatGrams)} g/day`;
            document.getElementById('fpCarbs').textContent = `Carbs: ${roundNumber(carbGrams)} g/day`;
            document.getElementById('fpFeeding').textContent = `Feeding: ${mealsPerDay} meals/day`;
            document.getElementById('fpWater').textContent = `Water: ${roundNumber(waterMl)} ml/day`;
            document.getElementById('fpWeeklyDelta').textContent = `Weekly change: ${weeklyDelta.toFixed(2)} kg/week`;

            document.getElementById('fpAiSummary').textContent =
                `For a ${age}-year-old ${animalType.toLowerCase()} with a ${fitnessGoal.toLowerCase()} goal, the plan targets ${roundNumber(adjustedCalories)} kcal/day across ${mealsPerDay} feedings with protein-focused balance.`;

            renderMicronutrients(micronutrients);
            renderFoods(foods);
        }

        function renderMicronutrients(microList) {
            const container = document.getElementById('fpMicronutrients');
            container.innerHTML = microList.map(item => `<span class="food-chip"><i class="fas fa-circle-dot"></i>${item}</span>`).join('');
        }

        function renderFoods(foods) {
            markedFoods = markedFoods.filter(name => foods.some(food => food.name === name));
            const container = document.getElementById('fpFoodsContainer');
            container.innerHTML = foods.map(food => {
                const marked = markedFoods.includes(food.name);
                return `
                    <div class="meal-card ${marked ? 'marked' : ''}">
                        <div class="d-flex align-items-start justify-content-between">
                            <div class="d-flex align-items-center">
                                <span class="food-logo"><i class="fas ${food.icon}"></i></span>
                                <div>
                                    <div class="fw-semibold">${food.name}</div>
                                    <small class="text-muted">Serving: ${food.serving || 'custom'}</small>
                                </div>
                            </div>
                            <div class="food-actions">
                            <button class="btn btn-sm ${marked ? 'btn-success' : 'btn-outline-success'}" type="button" onclick="toggleFoodMark('${food.name.replace(/'/g, "\\'")}')">
                                ${marked ? '<i class="fas fa-circle-check"></i>' : '<i class="far fa-circle"></i>'}
                            </button>
                            <button class="btn btn-sm btn-outline-primary" type="button" onclick="editFoodItem('${food.name.replace(/'/g, "\\'")}')">
                                <i class="fas fa-pen"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" type="button" onclick="deleteFoodItem('${food.name.replace(/'/g, "\\'")}')">
                                <i class="fas fa-trash"></i>
                            </button>
                            </div>
                        </div>
                        <div class="meal-meta">
                            <span class="badge text-bg-light">${food.calories || 0} kcal</span>
                            <span class="badge text-bg-light">P ${Number(food.protein || 0).toFixed(1)}g</span>
                            <span class="badge text-bg-light">C ${Number(food.carbs || 0).toFixed(1)}g</span>
                            <span class="badge text-bg-light">F ${Number(food.fats || 0).toFixed(1)}g</span>
                        </div>
                    </div>
                `;
            }).join('');
            updateFoodPlanScore(foods.length);
        }

        function toggleFoodMark(foodName) {
            if (markedFoods.includes(foodName)) {
                markedFoods = markedFoods.filter(item => item !== foodName);
            } else {
                markedFoods.push(foodName);
            }
            calculateFoodPlan();
        }

        function updateFoodPlanScore(totalFoods) {
            const safeTotal = totalFoods || 1;
            const score = roundNumber((markedFoods.length / safeTotal) * 100);
            document.getElementById('fpScoreText').textContent = `${score}%`;
            document.getElementById('fpScoreBar').style.width = `${score}%`;
            document.getElementById('fpMarkedCount').textContent = `${markedFoods.length}/${totalFoods} marked`;
            updateSelectedNutrition();
        }

        function updateSelectedNutrition() {
            const animalType = getSelectedAnimalType();
            const foods = foodPlanFoodsByAnimal[animalType] || [];
            const selectedFoods = foods.filter(food => markedFoods.includes(food.name));

            const totals = selectedFoods.reduce((acc, food) => {
                acc.calories += Number(food.calories || 0);
                acc.protein += Number(food.protein || 0);
                acc.carbs += Number(food.carbs || 0);
                acc.fats += Number(food.fats || 0);
                return acc;
            }, { calories: 0, protein: 0, carbs: 0, fats: 0 });

            const multiplier = fpViewMode === 'weekly' ? 7 : 1;
            const proteinTarget = currentFoodMacroTargets.protein * multiplier;
            const carbsTarget = currentFoodMacroTargets.carbs * multiplier;
            const fatsTarget = currentFoodMacroTargets.fats * multiplier;

            const proteinProgress = proteinTarget > 0 ? Math.min(100, (totals.protein / proteinTarget) * 100) : 0;
            const carbsProgress = carbsTarget > 0 ? Math.min(100, (totals.carbs / carbsTarget) * 100) : 0;
            const fatsProgress = fatsTarget > 0 ? Math.min(100, (totals.fats / fatsTarget) * 100) : 0;

            document.getElementById('fpSelectedCalories').textContent = `Calories: ${roundNumber(totals.calories)} kcal`;
            document.getElementById('fpSelectedProtein').textContent = `Protein: ${totals.protein.toFixed(1)} g`;
            document.getElementById('fpSelectedCarbs').textContent = `Carbs: ${totals.carbs.toFixed(1)} g`;
            document.getElementById('fpSelectedFats').textContent = `Fats: ${totals.fats.toFixed(1)} g`;
            document.getElementById('fpProteinProgress').style.width = `${proteinProgress}%`;
            document.getElementById('fpCarbsProgress').style.width = `${carbsProgress}%`;
            document.getElementById('fpProteinProgressText').textContent = `Protein ${fpViewMode} target: ${roundNumber(proteinProgress)}% (${proteinTarget.toFixed(0)}g target)`;
            document.getElementById('fpCarbsProgressText').textContent = `Carbs ${fpViewMode} target: ${roundNumber(carbsProgress)}% (${carbsTarget.toFixed(0)}g target)`;

            const proteinRing = document.getElementById('fpProteinRing');
            const carbsRing = document.getElementById('fpCarbsRing');
            const fatsRing = document.getElementById('fpFatsRing');

            proteinRing.style.setProperty('--ringValue', `${Math.round((proteinProgress / 100) * 360)}deg`);
            carbsRing.style.setProperty('--ringValue', `${Math.round((carbsProgress / 100) * 360)}deg`);
            fatsRing.style.setProperty('--ringValue', `${Math.round((fatsProgress / 100) * 360)}deg`);

            proteinRing.textContent = `${roundNumber(proteinProgress)}%`;
            carbsRing.textContent = `${roundNumber(carbsProgress)}%`;
            fatsRing.textContent = `${roundNumber(fatsProgress)}%`;
            updateMacroComparisonGraph(totals, proteinTarget, carbsTarget, fatsTarget);
        }

        function updateMacroComparisonGraph(totals, proteinTarget, carbsTarget, fatsTarget) {
            const toGraphWidth = (value, target) => {
                if (!target || target <= 0) return 0;
                // Allow overflow visualization up to 140%
                return Math.min(140, (value / target) * 100);
            };

            const proteinWidth = toGraphWidth(totals.protein, proteinTarget);
            const carbsWidth = toGraphWidth(totals.carbs, carbsTarget);
            const fatsWidth = toGraphWidth(totals.fats, fatsTarget);

            document.getElementById('fpGraphProteinBar').style.width = `${proteinWidth}%`;
            document.getElementById('fpGraphCarbsBar').style.width = `${carbsWidth}%`;
            document.getElementById('fpGraphFatsBar').style.width = `${fatsWidth}%`;

            document.getElementById('fpGraphProteinText').textContent = `${totals.protein.toFixed(1)} / ${proteinTarget.toFixed(0)} g`;
            document.getElementById('fpGraphCarbsText').textContent = `${totals.carbs.toFixed(1)} / ${carbsTarget.toFixed(0)} g`;
            document.getElementById('fpGraphFatsText').textContent = `${totals.fats.toFixed(1)} / ${fatsTarget.toFixed(0)} g`;
            drawMacroCanvasChart(totals, proteinTarget, carbsTarget, fatsTarget);
        }

        function drawMacroCanvasChart(totals, proteinTarget, carbsTarget, fatsTarget) {
            const canvas = document.getElementById('fpMacroCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const cssWidth = canvas.clientWidth || 360;
            const cssHeight = canvas.clientHeight || 180;
            const dpr = window.devicePixelRatio || 1;

            canvas.width = Math.floor(cssWidth * dpr);
            canvas.height = Math.floor(cssHeight * dpr);
            ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

            const w = cssWidth;
            const h = cssHeight;
            ctx.clearRect(0, 0, w, h);

            // background grid
            ctx.strokeStyle = '#e5edf6';
            ctx.lineWidth = 1;
            for (let i = 1; i <= 4; i++) {
                const y = (h / 5) * i;
                ctx.beginPath();
                ctx.moveTo(35, y);
                ctx.lineTo(w - 10, y);
                ctx.stroke();
            }

            const data = [
                { key: 'Protein', value: totals.protein, target: proteinTarget, color: '#16a34a' },
                { key: 'Carbs', value: totals.carbs, target: carbsTarget, color: '#0284c7' },
                { key: 'Fats', value: totals.fats, target: fatsTarget, color: '#d97706' },
            ];

            const maxVal = Math.max(
                1,
                ...data.map(d => d.target || 0),
                ...data.map(d => d.value || 0)
            );

            const chartLeft = 48;
            const chartRight = w - 14;
            const chartBottom = h - 24;
            const chartTop = 10;
            const chartHeight = chartBottom - chartTop;
            const slotWidth = (chartRight - chartLeft) / data.length;
            const barWidth = Math.min(40, slotWidth * 0.45);

            // axes
            ctx.strokeStyle = '#cbd5e1';
            ctx.beginPath();
            ctx.moveTo(chartLeft, chartTop);
            ctx.lineTo(chartLeft, chartBottom);
            ctx.lineTo(chartRight, chartBottom);
            ctx.stroke();

            ctx.font = '11px Segoe UI';
            ctx.fillStyle = '#64748b';
            ctx.fillText('0', 30, chartBottom + 3);
            ctx.fillText(String(Math.round(maxVal)), 14, chartTop + 4);

            data.forEach((item, i) => {
                const xCenter = chartLeft + slotWidth * i + slotWidth / 2;
                const selectedH = (Math.max(0, item.value) / maxVal) * chartHeight;
                const targetH = (Math.max(0, item.target) / maxVal) * chartHeight;

                // target bar (light)
                ctx.fillStyle = '#dbe7f4';
                ctx.fillRect(xCenter - barWidth / 2, chartBottom - targetH, barWidth, targetH);

                // selected overlay bar
                ctx.fillStyle = item.color;
                ctx.fillRect(xCenter - (barWidth / 2) + 5, chartBottom - selectedH, barWidth - 10, selectedH);

                // value label
                ctx.fillStyle = '#0f172a';
                ctx.font = '700 11px Segoe UI';
                ctx.fillText(Math.round(item.value).toString(), xCenter - 8, chartBottom - selectedH - 6);

                // x labels
                ctx.fillStyle = '#475569';
                ctx.font = '11px Segoe UI';
                ctx.fillText(item.key, xCenter - 18, chartBottom + 14);
            });
        }

        function getSelectedAnimalType() {
            return document.getElementById('fpAnimalType').value;
        }

        function addFoodItem() {
            const input = document.getElementById('fpNewFoodInput');
            const newName = (input.value || '').trim();
            if (!newName) return;

            const animalType = getSelectedAnimalType();
            const foods = foodPlanFoodsByAnimal[animalType] || [];
            if (foods.some(item => item.name.toLowerCase() === newName.toLowerCase())) {
                showNotification('Food already exists in this list', 'warning');
                return;
            }

            foods.push({
                name: newName,
                icon: 'fa-bowl-food',
                serving: 'custom',
                calories: 50,
                protein: 2,
                carbs: 6,
                fats: 1
            });
            foodPlanFoodsByAnimal[animalType] = foods;
            input.value = '';
            calculateFoodPlan();
        }

        function editFoodItem(foodName) {
            const animalType = getSelectedAnimalType();
            const foods = foodPlanFoodsByAnimal[animalType] || [];
            const item = foods.find(f => f.name === foodName);
            if (!item) return;

            const updated = prompt('Edit food name:', item.name);
            if (updated === null) return;
            const cleanName = updated.trim();
            if (!cleanName) return;

            const nameExists = foods.some(f => f.name.toLowerCase() === cleanName.toLowerCase() && f.name !== item.name);
            if (nameExists) {
                showNotification('Food with this name already exists', 'warning');
                return;
            }

            const oldName = item.name;
            item.name = cleanName;
            markedFoods = markedFoods.map(name => (name === oldName ? cleanName : name));

            const nutritionInput = prompt(
                'Edit nutrition as calories,protein,carbs,fats (example: 120,8,15,3):',
                `${item.calories || 0},${item.protein || 0},${item.carbs || 0},${item.fats || 0}`
            );
            if (nutritionInput) {
                const parts = nutritionInput.split(',').map(v => Number(v.trim()));
                if (parts.length === 4 && parts.every(v => !Number.isNaN(v))) {
                    item.calories = parts[0];
                    item.protein = parts[1];
                    item.carbs = parts[2];
                    item.fats = parts[3];
                }
            }

            calculateFoodPlan();
        }

        function deleteFoodItem(foodName) {
            const animalType = getSelectedAnimalType();
            const foods = foodPlanFoodsByAnimal[animalType] || [];
            foodPlanFoodsByAnimal[animalType] = foods.filter(item => item.name !== foodName);
            markedFoods = markedFoods.filter(name => name !== foodName);
            calculateFoodPlan();
        }

        function clearFoodMarks() {
            markedFoods = [];
            calculateFoodPlan();
        }

        function loadPetsForWellness() {
            fetch('/api/get_pets')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const selects = ['petSelect', 'reminderPet'];
                        selects.forEach(selectId => {
                            const select = document.getElementById(selectId);
                            if (selectId === 'petSelect') {
                                select.innerHTML = '<option value="">All Pets</option>';
                            } else {
                                select.innerHTML = '<option value="">Choose your pet...</option>';
                            }
                            data.pets.forEach(pet => {
                                select.innerHTML += `<option value="${pet.id}">${pet.name} (${pet.species})</option>`;
                            });
                        });
                    }
                });
        }

        function loadReminders() {
            const selectedPetId = document.getElementById('petSelect').value;
            fetch('/api/get_reminders' + (selectedPetId ? `?pet_id=${selectedPetId}` : ''))
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayReminders(data.reminders);
                        updateWellnessScore(data.reminders); // Ensure wellness score is updated
                        
                        // Announce pending reminders if any exist
                        const pendingReminders = data.reminders.filter(r => !r.completed);
                        const announceBtn = document.getElementById('wellnessAnnounceBtn');
                        
                        if (pendingReminders.length > 0) {
                            announceBtn.style.display = 'inline-block';
                            // Announce pending reminders only once per page visit
                            if (!hasAnnouncedReminders) {
                                setTimeout(() => {
                                    announcePendingReminders(pendingReminders);
                                    hasAnnouncedReminders = true;
                                }, 1000); // 1 second delay
                            }
                        } else {
                            announceBtn.style.display = 'none';
                        }
                    }
                });
        }

        // Function to announce pending reminders using Murf TTS
        function announcePendingReminders(pendingReminders) {
            if (!pendingReminders || pendingReminders.length === 0) return;
            
            const now = new Date();
            const overdue = pendingReminders.filter(r => new Date(r.due_date) < now);
            const upcoming = pendingReminders.filter(r => new Date(r.due_date) >= now);
            
            let announcementText = '';
            
            if (overdue.length > 0) {
                announcementText += `You have ${overdue.length} overdue reminder${overdue.length > 1 ? 's' : ''} for your pets. `;
                
                // Add specific overdue reminders (limit to 3 to keep it concise)
                const overdueDetails = overdue.slice(0, 3).map(r => r.title).join(', ');
                if (overdueDetails) {
                    announcementText += `Overdue tasks include: ${overdueDetails}. `;
                }
            }
            
            if (upcoming.length > 0) {
                announcementText += `You have ${upcoming.length} upcoming reminder${upcoming.length > 1 ? 's' : ''} scheduled. `;
                
                // Add specific upcoming reminders (limit to 3 to keep it concise)
                const upcomingDetails = upcoming.slice(0, 3).map(r => r.title).join(', ');
                if (upcomingDetails) {
                    announcementText += `Upcoming tasks include: ${upcomingDetails}. `;
                }
            }
            
            announcementText += 'Please review and complete them to maintain your pets\' health.';
            
            // TTS disabled as per user request
            console.log('Announcement (text only):', announcementText);
        }

        // Manual announcement function for wellness page
        function announceRemindersManually() {
            const selectedPetId = document.getElementById('petSelect').value;
            fetch('/api/get_reminders' + (selectedPetId ? `?pet_id=${selectedPetId}` : ''))
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const pendingReminders = data.reminders.filter(r => !r.completed);
                        if (pendingReminders.length > 0) {
                            announcePendingReminders(pendingReminders);
                        } else {
                            console.log('No pending reminders at this time.');
                        }
                    }
                });
        }

        function displayReminders(reminders) {
            const container = document.getElementById('remindersContainer');

            if (reminders.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-calendar-plus fa-3x mb-3"></i>
                        <h6>No reminders scheduled</h6>
                        <p class="small">Add your first wellness reminder to get started</p>
                    </div>
                `;
                return;
            }

            const now = new Date();
            const upcoming = reminders.filter(r => !r.completed && new Date(r.due_date) >= now);
            const overdue = reminders.filter(r => !r.completed && new Date(r.due_date) < now);
            const completed = reminders.filter(r => r.completed);

            container.innerHTML = `
                ${overdue.length > 0 ? `
                    <div class="p-3 border-bottom">
                        <h6 class="text-danger mb-3"><i class="fas fa-exclamation-triangle me-2"></i>Overdue (${overdue.length})</h6>
                        ${overdue.map(reminder => renderReminderItem(reminder, 'danger')).join('')}
                    </div>
                ` : ''}

                ${upcoming.length > 0 ? `
                    <div class="p-3 border-bottom">
                        <h6 class="text-primary mb-3"><i class="fas fa-clock me-2"></i>Upcoming (${upcoming.length})</h6>
                        ${upcoming.map(reminder => renderReminderItem(reminder, 'primary')).join('')}
                    </div>
                ` : ''}

                ${completed.length > 0 ? `
                    <div class="p-3">
                        <h6 class="text-success mb-3"><i class="fas fa-check-circle me-2"></i>Completed (${completed.length})</h6>
                        ${completed.slice(0, 5).map(reminder => renderReminderItem(reminder, 'success')).join('')}
                    </div>
                ` : ''}
            `;
        }

        function renderReminderItem(reminder, type) {
            const dueDate = new Date(reminder.due_date);
            const isOverdue = !reminder.completed && dueDate < new Date();

            return `
                <div class="d-flex align-items-center justify-content-between mb-2">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-${getReminderIcon(reminder.title)} text-${type} me-2"></i>
                            <div>
                                <h6 class="mb-0 ${reminder.completed ? 'text-decoration-line-through' : ''}">${reminder.title}</h6>
                                <small class="text-muted">${formatDateTime(reminder.due_date)}</small>
                            </div>
                        </div>
                    </div>
                    <div>
                        ${!reminder.completed ? `
                            <button class="btn btn-success btn-sm" onclick="completeReminder(${reminder.id})">
                                <i class="fas fa-check"></i>
                            </button>
                        ` : `
                            <span class="badge bg-success">Done</span>
                        `}
                    </div>
                </div>
            `;
        }

        function getReminderIcon(title) {
            const iconMap = {
                'vaccination': 'syringe',
                'grooming': 'cut',
                'checkup': 'stethoscope',
                'medication': 'pills',
                'flea': 'bug',
                'deworming': 'shield-alt',
                'nail': 'scissors',
                'dental': 'tooth'
            };

            for (const [key, icon] of Object.entries(iconMap)) {
                if (title.toLowerCase().includes(key)) {
                    return icon;
                }
            }
            return 'calendar-alt';
        }

        function showAddReminderModal() {
            const modal = new bootstrap.Modal(document.getElementById('addReminderModal'));
            modal.show();
        }

        function addReminder(type) {
            document.getElementById('reminderType').value = type;
            document.getElementById('reminderTitle').value = type.charAt(0).toUpperCase() + type.slice(1) + ' Reminder';
            showAddReminderModal();
        }

        function saveReminder() {
            const form = document.getElementById('reminderForm');
            const petId = document.getElementById('reminderPet').value;
            const title = document.getElementById('reminderTitle').value;
            const dueDate = document.getElementById('reminderDate').value;

            if (!petId || !title || !dueDate) {
                alert('Please fill in all required fields');
                return;
            }

            fetch('/api/add_reminder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    pet_id: parseInt(petId),
                    title: title,
                    due_date: dueDate
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('addReminderModal')).hide();
                    form.reset();
                    loadReminders();
                    showNotification('Reminder added successfully!', 'success');
                    
                    // Voice confirmation
                    speakText('Reminder added successfully! It has been scheduled for your pet.', { voiceId: 'en-US-natalie' });
                } else {
                    showNotification('Error adding reminder: ' + data.error, 'error');
                    speakText('Sorry, there was an error adding the reminder. Please try again.', { voiceId: 'en-US-natalie' });
                }
            })
            .catch(error => {
                showNotification('Error adding reminder: ' + error.message, 'error');
            });
        }

        function completeReminder(reminderId) {
            fetch(`/api/complete_reminder/${reminderId}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadReminders();
                    loadWellnessInsights(); // Refresh wellness insights immediately
                    showNotification('Reminder completed!', 'success');
                    
                    // Voice confirmation
                    speakText('Reminder completed successfully! Great job taking care of your pet.', { voiceId: 'en-US-natalie' });
                } else {
                    showNotification('Error completing reminder', 'error');
                    speakText('Sorry, there was an error completing the reminder. Please try again.', { voiceId: 'en-US-natalie' });
                }
            });
        }

        function loadWellnessData() {
            loadReminders();
            loadWellnessInsights(); // Load insights when pet is changed
        }

        function generateMiniCalendar() {
            const calendar = document.getElementById('miniCalendar');
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const selectedPetId = document.getElementById('petSelect').value;

            // Fetch history and reminders to mark on calendar
            Promise.all([
                fetch('/api/get_history' + (selectedPetId ? `?pet_id=${selectedPetId}` : '')).then(r => r.json()),
                fetch('/api/get_reminders' + (selectedPetId ? `?pet_id=${selectedPetId}` : '')).then(r => r.json())
            ]).then(([historyData, remindersData]) => {
                const historyDates = historyData.success ? historyData.history.map(h => h.date.split('T')[0]) : [];
                const reminderDates = remindersData.success ? remindersData.reminders.map(r => r.due_date.split('T')[0]) : [];

                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const monthName = now.toLocaleString('default', { month: 'short' });

                let html = `
                    <div class="mini-cal-wrap">
                    <div class="mini-cal-month">${monthName} ${year}</div>
                    <table class="mini-cal-table">
                        <thead>
                            <tr>
                                <th>S</th><th>M</th><th>T</th><th>W</th><th>T</th><th>F</th><th>S</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                `;

                for (let i = 0; i < firstDay; i++) {
                    html += '<td></td>';
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    if ((firstDay + day - 1) % 7 === 0 && day > 1) {
                        html += '</tr><tr>';
                    }
                    
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    let dayClass = 'mini-cal-day';
                    let dotHtml = '<div class="mini-cal-dots">';
                    
                    if (day === now.getDate()) {
                        dayClass += ' today';
                    }
                    
                    if (historyDates.includes(dateStr)) {
                        dotHtml += '<span class="mini-dot history"></span>';
                    }
                    if (reminderDates.includes(dateStr)) {
                        dotHtml += '<span class="mini-dot reminder"></span>';
                    }
                    dotHtml += '</div>';

                    html += `<td><div class="${dayClass}" title="${dateStr}">${day}</div>${dotHtml}</td>`;
                }

                html += '</tr></tbody></table>';
                html += `
                    <div class="mini-cal-legend">
                        <span><i class="fas fa-circle text-success me-1" style="font-size: 0.5rem;"></i>History</span>
                        <span><i class="fas fa-circle text-warning me-1" style="font-size: 0.5rem;"></i>Reminders</span>
                    </div>
                    </div>
                `;
                calendar.innerHTML = html;
            }).catch(err => {
                console.error('Error generating calendar:', err);
                calendar.innerHTML = '<p class="text-danger small">Error loading calendar data</p>';
            });
        }

        // Handle reminder type change
        document.getElementById('reminderType').addEventListener('change', function() {
            const type = this.value;
            const titleField = document.getElementById('reminderTitle');
            if (type && type !== 'other') {
                titleField.value = type.charAt(0).toUpperCase() + type.slice(1).replace('_', ' ') + ' Reminder';
            }
        });

        // Utility functions
        function formatDateTime(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        function showNotification(message, type) {
            // Use the global notification function
            if (window.PetHealthPro && window.PetHealthPro.showNotification) {
                window.PetHealthPro.showNotification(message, type);
            } else {
                alert(message);
            }
        }

        // Load wellness insights
        function loadWellnessInsights() {
            let healthHistoryData = [];
            let remindersData = [];

            // Get health history to calculate metrics
            fetch('/api/get_health_history')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        healthHistoryData = data.health_history;
                        // Calculate metrics with both health history and reminders
                        calculateWellnessMetrics(healthHistoryData, remindersData);
                    }
                });

            // Get reminders to calculate completion rate
            fetch('/api/get_reminders')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        remindersData = data.reminders;
                        updateWellnessScore(data.reminders);
                        // Update metrics with reminders data
                        calculateWellnessMetrics(healthHistoryData, remindersData);
                    }
                });
        }

        function calculateWellnessMetrics(healthHistory, reminders = []) {
            const lastCheckupElement = document.getElementById('lastCheckupText');

            // Check for completed checkup reminders first
            const completedCheckupReminders = reminders.filter(r => 
                r.completed && 
                (r.title.toLowerCase().includes('checkup') || 
                 r.title.toLowerCase().includes('vet') ||
                 r.title.toLowerCase().includes('examination'))
            ).sort((a, b) => {
                const dateA = a.completed_date ? new Date(a.completed_date) : new Date(a.due_date);
                const dateB = b.completed_date ? new Date(b.completed_date) : new Date(b.due_date);
                return dateB - dateA;
            });

            // Also check health history for actual checkups
            const checkupHistory = healthHistory ? healthHistory.filter(h => 
                h.symptoms && (
                    h.symptoms.toLowerCase().includes('checkup') || 
                    h.symptoms.toLowerCase().includes('examination') ||
                    (h.recommendation && h.recommendation.toLowerCase().includes('checkup'))
                )
            ).sort((a, b) => new Date(b.date) - new Date(a.date)) : [];

            let lastCheckupDate = null;

            // Find the most recent checkup from completed reminders
            if (completedCheckupReminders.length > 0) {
                const latestReminder = completedCheckupReminders[0];
                lastCheckupDate = latestReminder.completed_date ? 
                    new Date(latestReminder.completed_date) : 
                    new Date(latestReminder.due_date);
            }

            // Check health history for actual recorded checkups
            if (checkupHistory.length > 0) {
                const historyDate = new Date(checkupHistory[0].date);
                if (!lastCheckupDate || historyDate > lastCheckupDate) {
                    lastCheckupDate = historyDate;
                }
            }

            if (lastCheckupDate) {
                const daysSinceCheckup = Math.floor((new Date() - lastCheckupDate) / (1000 * 60 * 60 * 24));

                // Handle edge case where completed reminder had a future due date
                if (daysSinceCheckup < 0) {
                    lastCheckupElement.textContent = 'Recently completed';
                    lastCheckupElement.className = 'text-success fw-bold';
                } else if (daysSinceCheckup === 0) {
                    lastCheckupElement.textContent = 'Today';
                    lastCheckupElement.className = 'text-success fw-bold';
                } else if (daysSinceCheckup <= 30) {
                    lastCheckupElement.textContent = `${daysSinceCheckup} days ago`;
                    lastCheckupElement.className = 'text-success fw-bold';
                } else if (daysSinceCheckup <= 90) {
                    lastCheckupElement.textContent = `${daysSinceCheckup} days ago`;
                    lastCheckupElement.className = 'text-warning';
                } else {
                    lastCheckupElement.textContent = `${daysSinceCheckup} days ago`;
                    lastCheckupElement.className = 'text-danger';
                }
            } else {
                lastCheckupElement.textContent = 'No records';
                lastCheckupElement.className = 'text-muted';
            }
        }

        function updateWellnessScore(reminders) {
            const vaccinationElement = document.getElementById('vaccinationStatusText');
            const wellnessProgressBar = document.getElementById('wellnessProgress');
            const wellnessScoreText = document.getElementById('wellnessScoreText');

            if (reminders && reminders.length > 0) {
                const completedReminders = reminders.filter(r => r.completed).length;
                const totalReminders = reminders.length;
                const completionRate = Math.round((completedReminders / totalReminders) * 100);

                // Update wellness score
                wellnessProgressBar.style.width = completionRate + '%';
                wellnessScoreText.textContent = `${completionRate}% - Based on reminder completion`;

                // Update progress bar color based on score
                wellnessProgressBar.className = 'progress-bar';
                if (completionRate >= 80) {
                    wellnessProgressBar.classList.add('bg-success');
                } else if (completionRate >= 60) {
                    wellnessProgressBar.classList.add('bg-warning');
                } else {
                    wellnessProgressBar.classList.add('bg-danger');
                }

                // Check for vaccination reminders
                const vaccinationReminders = reminders.filter(r => 
                    r.title.toLowerCase().includes('vaccination') || 
                    r.title.toLowerCase().includes('vaccine') ||
                    r.title.toLowerCase().includes('shot')
                );

                if (vaccinationReminders.length > 0) {
                    const completedVaccinations = vaccinationReminders.filter(r => r.completed).length;
                    const overdueVaccinations = vaccinationReminders.filter(r => 
                        !r.completed && new Date(r.due_date) < new Date()
                    ).length;

                    if (overdueVaccinations > 0) {
                        vaccinationElement.textContent = `${overdueVaccinations} overdue`;
                        vaccinationElement.className = 'text-danger fw-bold';
                    } else if (completedVaccinations === vaccinationReminders.length) {
                        vaccinationElement.textContent = 'Up to date';
                        vaccinationElement.className = 'text-success fw-bold';
                    } else {
                        vaccinationElement.textContent = 'Partial';
                        vaccinationElement.className = 'text-warning';
                    }
                } else {
                    vaccinationElement.textContent = 'No records';
                    vaccinationElement.className = 'text-muted';
                }
            } else {
                wellnessProgressBar.style.width = '0%';
                wellnessScoreText.textContent = '0% - No reminders set';
                vaccinationElement.textContent = 'No records';
                vaccinationElement.className = 'text-muted';
            }
        }
    </script>
</body>

</html>
