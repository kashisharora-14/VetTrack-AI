<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <title>Symptom Checker - VetTrack Ai</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
  <style>
    .wizard-shell { max-width: 1240px; }
    .stepper { display:flex; gap:.5rem; flex-wrap:wrap; }
    .step-pill { padding:.45rem .75rem; border:1px solid #dbe5f1; border-radius:999px; font-size:.8rem; color:#64748b; background:#fff; }
    .step-pill.active { background:#eaf3ff; color:#1d4f91; border-color:#9ec2ee; font-weight:700; }

    .wizard-step { display:none; }
    .wizard-step.active { display:block; }

    .pet-grid { display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:1rem; align-items:stretch; }
    .pet-card {
      border:1px solid #dbe6f1;
      border-radius:24px;
      padding:1.1rem .95rem .95rem .95rem;
      min-height:310px;
      background:#fff;
      cursor:pointer;
      transition:.2s ease;
    }
    .pet-card:hover { box-shadow:0 12px 28px rgba(16,24,40,.1); transform:translateY(-3px); }
    .pet-card.active { border-color:#78ade6; box-shadow:0 14px 30px rgba(47,128,237,.16); background:#f8fbff; }
    .pet-avatar { width:96px; height:96px; border-radius:50%; object-fit:cover; display:block; margin:0 auto .85rem auto; border:3px solid #edf3fa; }
    .pet-name { text-align:center; font-size:1.14rem; font-weight:800; color:#1e293b; margin-bottom:.22rem; }
    .pet-meta { text-align:center; font-size:.82rem; color:#75879c; min-height:20px; }
    .pet-stats { margin-top:.95rem; display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:.4rem; }
    .pet-stat {
      border:none;
      border-radius:12px;
      background:#f9fbff;
      text-align:center;
      padding:.44rem .22rem;
      line-height:1.15;
    }
    .pet-stat i { color:#8aa1ba; margin-bottom:.18rem; display:block; font-size:.72rem; }
    .pet-stat-label { display:block; font-size:.58rem; color:#8aa1ba; text-transform:uppercase; letter-spacing:.04em; }
    .pet-stat-value { display:block; font-size:.69rem; color:#334155; font-weight:700; }
    .add-pet-card {
      border:1px dashed #d9e4ef;
      border-radius:24px;
      min-height:310px;
      background:#fff;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      gap:.6rem;
      color:#607a95;
      text-decoration:none;
      transition:.2s ease;
    }
    .add-pet-card:hover { background:#f8fbff; box-shadow:0 10px 22px rgba(16,24,40,.08); transform:translateY(-2px); border-color:#bcd2ea; }
    .add-pet-icon {
      width:58px;
      height:58px;
      border-radius:50%;
      display:grid;
      place-items:center;
      background:#f1f6fc;
      color:#7894b0;
      font-size:1.3rem;
    }

    .category-grid { display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:1rem; }
    .category-card { border:1px solid #dbe5f1; border-radius:14px; padding:.9rem; background:#fff; }
    .category-title { font-size:.85rem; font-weight:800; color:#334155; margin-bottom:.5rem; text-transform:uppercase; letter-spacing:.02em; }
    .symptom-tags { display:flex; flex-wrap:wrap; gap:.45rem; }
    .symptom-item input { position:absolute; opacity:0; pointer-events:none; }
    .symptom-chip { border:1px solid #d8e4ef; background:#fff; border-radius:999px; padding:.35rem .7rem; font-size:.82rem; color:#334155; cursor:pointer; user-select:none; }
    .symptom-item input:checked + .symptom-chip { background:#edf5ff; border-color:#9dc3ec; color:#0f4b8a; font-weight:700; }

    .dropzone { border:2px dashed #b8c7d9; border-radius:20px; background:#f9fbff; min-height:320px; display:grid; place-items:center; text-align:center; padding:1.4rem; cursor:pointer; }
    .dropzone.drag { border-color:#2f80ed; background:#eef5ff; }
    .preview { max-width:100%; max-height:260px; border-radius:14px; object-fit:contain; }
    .upload-hero {
      width:94px;
      height:94px;
      border-radius:24px;
      background:linear-gradient(180deg,#e8f2ff 0%, #dcecff 100%);
      display:grid;
      place-items:center;
      margin:0 auto .75rem auto;
      color:#2f80ed;
      font-size:2rem;
      box-shadow:0 10px 24px rgba(47,128,237,.2);
    }
    .result-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:1rem; align-items:stretch; }
    .result-card { border:1px solid #dbe6f1; border-radius:20px; background:#fff; padding:1.1rem; box-shadow:0 14px 32px rgba(15,39,71,.08); height:100%; }
    .result-card h6 { margin-bottom:.55rem; font-weight:800; color:#0f2747; }
    .result-card ul { margin-bottom:0; padding-left:1.1rem; }
    .result-layout { display:grid; grid-template-columns:minmax(0,1.9fr) minmax(300px,.95fr); gap:1.1rem; align-items:start; }
    .result-rail { position:sticky; top:98px; display:grid; gap:.9rem; align-self:start; }
    .action-card { border:1px solid #dbe6f1; border-radius:20px; background:#fff; padding:1rem; box-shadow:0 14px 32px rgba(15,39,71,.08); }
    .action-btn { width:100%; border-radius:12px; padding:.68rem .85rem; font-weight:700; }
    .action-card .btn + .btn { margin-top:.6rem; }
    .notify-host { z-index:1080; }
    .result-image { max-height:240px; border-radius:18px; box-shadow:0 12px 28px rgba(15,39,71,.12); }
    .results-hero { border:1px solid #dbe6f1; border-radius:22px; background:#fff; padding:1rem 1.1rem; box-shadow:0 14px 32px rgba(15,39,71,.08); margin-bottom:1rem; }
    .hero-title { font-size:1.12rem; font-weight:800; color:#0f2747; }
    .metric-row { display:flex; gap:.55rem; flex-wrap:wrap; margin-top:.65rem; }
    .metric-pill { display:inline-flex; align-items:center; gap:.4rem; border:1px solid #dbe6f1; border-radius:999px; padding:.42rem .7rem; background:#f8fbff; font-size:.8rem; color:#3f5671; }
    .section-title { display:flex; align-items:center; gap:.55rem; margin-bottom:.55rem; }
    .logo-dot { width:32px; height:32px; border-radius:11px; display:grid; place-items:center; background:#e8f2ff; color:#2f80ed; font-size:.92rem; }
    .flat-panel { border:1px solid #dbe6f1; border-radius:18px; background:#f8fbff; padding:1rem; }
    .result-warning {
      border: 1px solid #f7d57a;
      background: #fff9e8;
      color: #6a4a00;
      border-radius: 14px;
      padding: .72rem .85rem;
      margin-bottom: .85rem;
      font-weight: 700;
    }
    .recommendation-box {
      border-radius: 14px;
      padding: .85rem .95rem;
      border: 1px solid #dbe6f1;
      background: #f8fbff;
    }
    .recommendation-box.warn {
      border-color: #f3d37a;
      background: #fff9e8;
      color: #6a4a00;
    }
    .recommendation-box.danger {
      border-color: #f3b3b8;
      background: #fff1f2;
      color: #8a1c26;
    }
    .recommendation-box.safe {
      border-color: #b8dfc7;
      background: #edf9f1;
      color: #1f5d36;
    }
    .top-duo { display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:1rem; }
    .mini-grid { display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:.55rem; }
    .mini-pill { border:1px solid #dbe6f1; border-radius:13px; background:#f8fbff; padding:.58rem .62rem; }
    .mini-label { font-size:.72rem; color:#6d7f94; }
    .mini-value { font-size:.95rem; color:#10233e; font-weight:700; }
    .premium-nav {
      position: sticky;
      top: 0;
      z-index: 1025;
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid #dbe6f1;
    }
    .nav-shell {
      min-height: 74px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .brand-wrap { display:flex; align-items:center; gap:.65rem; color:#10233e; text-decoration:none; }
    .brand-logo {
      width:40px;
      height:40px;
      border-radius:13px;
      display:grid;
      place-items:center;
      background:linear-gradient(180deg,#e9f2ff 0%, #dfeefe 100%);
      color:#2f80ed;
      box-shadow:0 8px 22px rgba(47,128,237,.24);
      font-size:1.05rem;
    }
    .brand-title { font-size:1.2rem; font-weight:800; line-height:1.1; }
    .brand-sub { display:block; font-size:.75rem; color:#6f8298; font-weight:600; letter-spacing:.02em; }
    .nav-cta {
      border:1px solid #dbe6f1;
      border-radius:12px;
      padding:.45rem .8rem;
      color:#355271;
      text-decoration:none;
      background:#f8fbff;
      font-weight:600;
    }
    .nav-cta:hover { background:#eef5ff; color:#1c4370; }

    .brain-wrap { width:220px; height:220px; margin:1rem auto 0 auto; position:relative; }
    .brain-core { width:86px; height:86px; border-radius:22px; background:#eff6ff; color:#2f80ed; display:grid; place-items:center; position:absolute; inset:0; margin:auto; animation:pulse 2s infinite; box-shadow:0 8px 24px rgba(47,128,237,.22); }
    .orbit { position:absolute; inset:0; border:1px dashed #c3d3e8; border-radius:50%; animation:spin 9s linear infinite; }
    .dot { width:10px; height:10px; border-radius:50%; background:#2f80ed; position:absolute; left:50%; top:0; transform:translateX(-50%); }
    .progress-shell { height:12px; background:#e8eef6; border-radius:999px; overflow:hidden; }
    .progress-barx { height:12px; background:#2f80ed; width:0; transition:width .2s ease; }

    @keyframes spin { from { transform:rotate(0deg); } to { transform:rotate(360deg); } }
    @keyframes pulse { 0%,100% { transform:scale(1); } 50% { transform:scale(1.08);} }

    @media (max-width: 992px) {
      .pet-grid { grid-template-columns:1fr 1fr; }
      .category-grid { grid-template-columns:1fr; }
      .top-duo { grid-template-columns:1fr; }
      .result-layout { grid-template-columns:1fr; }
      .result-rail { position:static; }
    }
    @media (max-width: 640px) {
      .pet-grid { grid-template-columns:1fr; }
      .brand-title { font-size:1.02rem; }
      .brand-sub { font-size:.68rem; }
    }
  </style>
</head>

<body class="bg-light">
  <div id="notifyHost" class="notify-host position-fixed top-0 end-0 p-3"></div>
  <nav class="premium-nav">
    <div class="container wizard-shell nav-shell">
      <a class="brand-wrap" href="{{ url_for('index') }}">
        <span class="brand-logo"><i class="fas fa-paw"></i></span>
        <span>
          <span class="brand-title">VetTrack AI</span>
          <span class="brand-sub">Smart Pet Health Assistant</span>
        </span>
      </a>
      <a class="nav-cta" href="{{ url_for('dashboard') }}"><i class="fas fa-arrow-left me-1"></i>Dashboard</a>
    </div>
  </nav>

  <div class="container py-4 wizard-shell">
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <h1 class="h3 mb-2 fw-bold">AI Pet Health Assessment</h1>
        <p class="text-muted mb-3">Complete each step to generate a full AI-powered health report.</p>
        <div class="stepper" id="stepper">
          <span class="step-pill active" data-step-pill="1">1. Select Pet</span>
          <span class="step-pill" data-step-pill="2">2. Symptoms</span>
          <span class="step-pill" data-step-pill="3">3. Visual Upload</span>
          <span class="step-pill" data-step-pill="4">4. AI Analysis</span>
          <span class="step-pill" data-step-pill="5">5. Results</span>
        </div>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-body p-4 p-lg-5">
        <form id="symptomForm">
          <input type="hidden" id="selectedPetId">

          <section class="wizard-step active" data-step="1">
            <h4 class="fw-bold mb-2 text-center">Who are we checking today?</h4>
            <p class="text-muted text-center mb-4">Choose the pet profile for personalized assessment.</p>
            <div id="petCards" class="pet-grid"></div>
            <div class="d-flex justify-content-end mt-4">
              <button type="button" class="btn btn-primary" onclick="nextStep()">Continue</button>
            </div>
          </section>

          <section class="wizard-step" data-step="2">
            <h4 class="fw-bold mb-2 text-center">What symptoms are you observing?</h4>
            <p class="text-muted text-center mb-4">Pick symptoms category-wise and add extra notes.</p>

            <div class="category-grid mb-3">
              <div class="category-card">
                <div class="category-title">Gastrointestinal</div>
                <div class="symptom-tags">
                  <label class="symptom-item"><input type="checkbox" value="vomiting"><span class="symptom-chip">Vomiting</span></label>
                  <label class="symptom-item"><input type="checkbox" value="diarrhea"><span class="symptom-chip">Diarrhea</span></label>
                  <label class="symptom-item"><input type="checkbox" value="loss of appetite"><span class="symptom-chip">Loss of Appetite</span></label>
                </div>
              </div>
              <div class="category-card">
                <div class="category-title">Respiratory</div>
                <div class="symptom-tags">
                  <label class="symptom-item"><input type="checkbox" value="coughing"><span class="symptom-chip">Coughing</span></label>
                  <label class="symptom-item"><input type="checkbox" value="sneezing"><span class="symptom-chip">Sneezing</span></label>
                  <label class="symptom-item"><input type="checkbox" value="labored breathing"><span class="symptom-chip">Labored Breathing</span></label>
                </div>
              </div>
              <div class="category-card">
                <div class="category-title">Skin & Coat</div>
                <div class="symptom-tags">
                  <label class="symptom-item"><input type="checkbox" value="scratching"><span class="symptom-chip">Excessive Scratching</span></label>
                  <label class="symptom-item"><input type="checkbox" value="hair loss"><span class="symptom-chip">Hair Loss</span></label>
                  <label class="symptom-item"><input type="checkbox" value="red skin"><span class="symptom-chip">Red Skin</span></label>
                </div>
              </div>
              <div class="category-card">
                <div class="category-title">General & Mobility</div>
                <div class="symptom-tags">
                  <label class="symptom-item"><input type="checkbox" value="lethargy"><span class="symptom-chip">Lethargy</span></label>
                  <label class="symptom-item"><input type="checkbox" value="limping"><span class="symptom-chip">Limping</span></label>
                  <label class="symptom-item"><input type="checkbox" value="excessive drinking"><span class="symptom-chip">Excessive Drinking</span></label>
                </div>
              </div>
            </div>

            <label class="form-label" for="symptomsText">Additional Notes</label>
            <textarea class="form-control" id="symptomsText" rows="4" placeholder="Describe timeline, severity, and anything unusual..."></textarea>

            <div class="d-flex justify-content-between mt-4">
              <button type="button" class="btn btn-outline-secondary" onclick="prevStep()">Back</button>
              <button type="button" class="btn btn-primary" onclick="nextStep()">Continue</button>
            </div>
          </section>

          <section class="wizard-step" data-step="3">
            <h4 class="fw-bold mb-2 text-center">Upload visual evidence (optional)</h4>
            <p class="text-muted text-center mb-4">Drag and drop an image of the affected area for better context.</p>

            <label id="dropZone" class="dropzone">
              <div id="dropText">
                <div class="upload-hero"><i class="fas fa-cloud-arrow-up"></i></div>
                <p class="mb-1 fw-semibold fs-5">Drag & drop pet image here</p>
                <p class="text-muted mb-3">or click to browse from your device</p>
                <div class="d-flex gap-2 justify-content-center flex-wrap small text-muted">
                  <span class="badge text-bg-light border">Good lighting</span>
                  <span class="badge text-bg-light border">Focused area</span>
                  <span class="badge text-bg-light border">Close framing</span>
                </div>
              </div>
              <img id="imagePreview" class="preview d-none" alt="Uploaded preview">
              <input id="symptomImage" type="file" accept="image/*" class="d-none">
            </label>

            <div class="d-flex justify-content-between mt-4">
              <button type="button" class="btn btn-outline-secondary" onclick="prevStep()">Back</button>
              <button type="button" class="btn btn-primary" onclick="startAnalysis()">Start Analysis</button>
            </div>
          </section>

          <section class="wizard-step" data-step="4">
            <h4 class="fw-bold mb-2 text-center">Analyzing pet health profile...</h4>
            <p class="text-muted text-center" id="statusText">Preparing AI engine...</p>

            <div class="brain-wrap">
              <div class="orbit"><span class="dot"></span></div>
              <div class="orbit" style="animation-duration:12s;"><span class="dot"></span></div>
              <div class="brain-core"><i class="fas fa-brain fa-2x"></i></div>
            </div>

            <div class="progress-shell mt-4">
              <div class="progress-barx" id="progressBar"></div>
            </div>
            <p class="text-center text-muted small mt-2"><span id="progressText">0</span>% completed</p>
          </section>

          <section class="wizard-step" data-step="5">
            <div id="resultsContent"></div>
            <div class="d-flex justify-content-between mt-4">
              <button type="button" class="btn btn-outline-primary" onclick="restartWizard()"><i class="fas fa-redo me-1"></i>New Assessment</button>
              <button type="button" class="btn btn-success" onclick="startConsultation()"><i class="fas fa-video me-1"></i>Consult Now</button>
            </div>
          </section>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="{{ url_for('static', filename='js/app.js') }}?v=tts1"></script>
  <script>
    let currentStep = 1;
    let uploadedImageFile = null;
    let analysisPayload = null;
    let analysisDone = false;
    let analysisImageUrl = '';
    let latestGuidance = { homeCare: [], monitor: [], redFlags: [] };

    const statusMessages = [
      'Mapping symptom signatures...',
      'Cross-checking behavior and visual context...',
      'Generating probable causes and urgency score...',
      'Building care recommendations...'
    ];

    document.addEventListener('DOMContentLoaded', function () {
      loadPetsForCards();
      setupImageDropzone();
    });

    function setStep(step) {
      currentStep = step;
      document.querySelectorAll('.wizard-step').forEach(el => el.classList.toggle('active', Number(el.dataset.step) === step));
      document.querySelectorAll('[data-step-pill]').forEach(el => el.classList.toggle('active', Number(el.dataset.stepPill) <= step));
    }

    function nextStep() {
      if (currentStep === 1 && !getSelectedPetId()) {
        return showNotification('Please select a pet profile first', 'warning');
      }
      if (currentStep === 2 && !buildSymptomsText().trim()) {
        return showNotification('Please select at least one symptom or add notes', 'warning');
      }
      setStep(Math.min(5, currentStep + 1));
    }

    function prevStep() {
      setStep(Math.max(1, currentStep - 1));
    }

    function loadPetsForCards() {
      fetch('/api/get_pets')
        .then(r => r.json())
        .then(data => {
          const cards = document.getElementById('petCards');
          if (!data.success) {
            cards.innerHTML = `<div class="alert alert-warning mb-0">Unable to load pet profiles right now.</div>`;
            return;
          }
          cards.innerHTML = '';
          if (!data.pets || !data.pets.length) {
            cards.innerHTML = `
              <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                  <h6 class="fw-bold mb-2">No pet profiles found</h6>
                  <p class="text-muted mb-3">Add your first pet profile to start symptom analysis.</p>
                  <a class="btn btn-primary btn-sm" href="{{ url_for('dashboard') }}">Go to Dashboard</a>
                </div>
              </div>
            `;
            return;
          }
          data.pets.forEach(pet => {
            const ageText = pet.age ? `${pet.age} yr` : 'N/A';
            const weightText = (pet.weight_kg !== null && pet.weight_kg !== undefined && pet.weight_kg !== '') ? `${pet.weight_kg} kg` : 'N/A';
            const genderText = pet.gender ? pet.gender : 'N/A';
            const avatar = pet.profile_picture
              ? `<img class="pet-avatar" src="/${pet.profile_picture}" alt="${pet.name}">`
              : `<img class="pet-avatar" src="https://placehold.co/100x100/e8f0f8/4a5f73?text=${encodeURIComponent((pet.name||'P').slice(0,1))}" alt="${pet.name}">`;

            const card = document.createElement('button');
            card.type = 'button';
            card.className = 'pet-card';
            card.setAttribute('data-id', String(pet.id));
            card.innerHTML = `
              ${avatar}
              <div class="pet-name">${pet.name}</div>
              <div class="pet-meta">${pet.breed || (pet.species || 'Pet')}</div>
              <div class="pet-stats">
                <div class="pet-stat">
                  <i class="fas fa-calendar"></i>
                  <span class="pet-stat-label">Age</span>
                  <span class="pet-stat-value">${ageText}</span>
                </div>
                <div class="pet-stat">
                  <i class="fas fa-weight-scale"></i>
                  <span class="pet-stat-label">Weight</span>
                  <span class="pet-stat-value">${weightText}</span>
                </div>
                <div class="pet-stat">
                  <i class="fas fa-venus-mars"></i>
                  <span class="pet-stat-label">Gender</span>
                  <span class="pet-stat-value">${genderText}</span>
                </div>
              </div>
            `;
            card.addEventListener('click', () => selectPetCard(card));
            cards.appendChild(card);
          });

          const addPetCard = document.createElement('a');
          addPetCard.href = "{{ url_for('dashboard') }}";
          addPetCard.className = 'add-pet-card';
          addPetCard.innerHTML = `
            <div class="add-pet-icon"><i class="fas fa-plus"></i></div>
            <div class="fw-bold fs-6">Add New Companion</div>
            <div class="text-muted text-center px-3 small">Create profile</div>
          `;
          cards.appendChild(addPetCard);
        });
    }

    function selectPetCard(card) {
      document.querySelectorAll('#petCards .pet-card').forEach(c => c.classList.remove('active'));
      card.classList.add('active');
      document.getElementById('selectedPetId').value = card.getAttribute('data-id') || '';
    }

    function getSelectedPetId() {
      return document.getElementById('selectedPetId')?.value || '';
    }

    function buildSymptomsText() {
      const selected = Array.from(document.querySelectorAll('.symptom-item input:checked')).map(i => i.value).filter(Boolean);
      const notes = document.getElementById('symptomsText').value.trim();
      const imageNote = uploadedImageFile ? 'Owner attached symptom image.' : '';
      return `Selected symptoms: ${selected.join(', ')}. Notes: ${notes}. ${imageNote}`.trim();
    }

    function setupImageDropzone() {
      const dropZone = document.getElementById('dropZone');
      const input = document.getElementById('symptomImage');
      const preview = document.getElementById('imagePreview');
      const text = document.getElementById('dropText');

      input.addEventListener('change', (e) => handleImageFile(e.target.files?.[0] || null));
      dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag'); });
      dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag'));
      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag');
        const file = e.dataTransfer.files?.[0] || null;
        handleImageFile(file);
      });

      function handleImageFile(file) {
        if (!file || !file.type.startsWith('image/')) return;
        uploadedImageFile = file;
        const reader = new FileReader();
        reader.onload = (ev) => {
          preview.src = ev.target.result;
          preview.classList.remove('d-none');
          text.classList.add('d-none');
        };
        reader.readAsDataURL(file);
      }
    }

    function startAnalysis() {
      const petId = getSelectedPetId();
      const symptoms = buildSymptomsText();
      if (!petId) return showNotification('Select a pet first', 'warning');
      if (!symptoms.trim()) return showNotification('Add symptoms before analysis', 'warning');

      setStep(4);
      analysisDone = false;
      analysisPayload = null;
      analysisImageUrl = '';

      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      const statusText = document.getElementById('statusText');

      let progress = 0;
      let statusIdx = 0;
      statusText.textContent = statusMessages[0];

      const statusTimer = setInterval(() => {
        statusIdx = (statusIdx + 1) % statusMessages.length;
        statusText.textContent = statusMessages[statusIdx];
      }, 2000);

      const progressTimer = setInterval(() => {
        progress = Math.min(100, progress + Math.floor(Math.random() * 8) + 2);
        progressBar.style.width = `${progress}%`;
        progressText.textContent = String(progress);
        if (progress >= 100) {
          clearInterval(progressTimer);
          if (analysisDone) {
            clearInterval(statusTimer);
            showFinalResults(analysisPayload);
          }
        }
      }, 220);

      runCombinedAnalysis(petId, symptoms)
        .then(payload => {
          analysisPayload = payload.analysis;
          analysisImageUrl = payload.imageUrl || '';
          analysisDone = true;
          if (progress >= 100) {
            clearInterval(statusTimer);
            showFinalResults(analysisPayload);
          }
        })
        .catch(err => {
          clearInterval(statusTimer);
          clearInterval(progressTimer);
          showNotification('Error analyzing symptoms: ' + err.message, 'error');
          setStep(3);
        });
    }

    function showFinalResults(analysis) {
      setStep(5);
      renderResults(analysis || {});
    }

    async function runCombinedAnalysis(petId, symptoms) {
      const symptomResponse = await fetch('/api/check_symptoms', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ pet_id: petId, symptoms })
      });
      const symptomData = await symptomResponse.json();
      if (!symptomResponse.ok || !symptomData.success) {
        throw new Error(symptomData.error || 'Symptom analysis failed');
      }

      let imageAnalysis = null;
      let imageUrl = '';
      if (uploadedImageFile) {
        const formData = new FormData();
        formData.append('pet_id', String(petId));
        formData.append('description', symptoms);
        formData.append('image', uploadedImageFile);

        const imageResponse = await fetch('/api/upload_image', {
          method: 'POST',
          body: formData
        });
        const imageData = await imageResponse.json();
        if (!imageResponse.ok || !imageData.success) {
          throw new Error(imageData.error || 'Image analysis failed');
        }
        imageAnalysis = imageData.analysis || null;
        imageUrl = imageData.image_url || '';
      }

      return {
        analysis: mergeAnalyses(symptomData.analysis || {}, imageAnalysis),
        imageUrl
      };
    }

    function toList(value) {
      if (Array.isArray(value)) return value.filter(Boolean);
      if (typeof value === 'string' && value.trim()) return [value.trim()];
      return [];
    }

    function uniqueList(items) {
      return Array.from(new Set((items || []).map(v => String(v).trim()).filter(Boolean)));
    }

    function urgencyRank(level) {
      const key = String(level || '').toLowerCase();
      if (key === 'emergency') return 4;
      if (key === 'high') return 3;
      if (key === 'medium' || key === 'moderate') return 2;
      if (key === 'low') return 1;
      return 0;
    }

    function isImageMismatch(imageAnalysis) {
      if (!imageAnalysis) return false;
      if (imageAnalysis.image_match === false) return true;
      const warningText = String(imageAnalysis.warningItem || '').toLowerCase();
      if (warningText.includes('does not match') || warningText.includes('mismatch')) return true;

      const text = [
        ...toList(imageAnalysis?.diagnosis),
        ...toList(imageAnalysis?.possible_causes),
        String(imageAnalysis?.recommendation || '')
      ].join(' ').toLowerCase();
      const keys = [
        'species mismatch',
        'different species',
        'different animal',
        'wrong pet',
        'not this pet',
        'not matching pet',
        'cannot confirm pet identity'
      ];
      return keys.some(k => text.includes(k));
    }

    function mergeAnalyses(symptomAnalysis, imageAnalysis) {
      if (!imageAnalysis) {
        return {
          ...(symptomAnalysis || {}),
          image_unmatched: false,
          image_result_status: 'not_uploaded'
        };
      }

      const symptomDiagnosis = toList(symptomAnalysis?.diagnosis);
      const imageDiagnosis = toList(imageAnalysis?.diagnosis);
      const symptomCauses = toList(symptomAnalysis?.possible_causes);
      const imageCauses = toList(imageAnalysis?.possible_causes);
      const symptomRecommendation = symptomAnalysis?.recommendation || '';
      const imageRecommendation = imageAnalysis?.recommendation || '';
      const symptomUrgency = symptomAnalysis?.urgency_level || 'Unknown';
      const imageUrgency = imageAnalysis?.urgency_level || imageAnalysis?.severity || 'Unknown';
      const mismatch = isImageMismatch(imageAnalysis);

      if (mismatch) {
        return {
          ...symptomAnalysis,
          diagnosis: uniqueList(symptomDiagnosis),
          possible_causes: uniqueList(symptomCauses),
          recommendation: [
            symptomRecommendation,
            'Warning: Uploaded image does not match selected pet profile. Image-based result is not available.'
          ].filter(Boolean).join(' '),
          urgency_level: symptomUrgency || 'Unknown',
          image_findings: [],
          image_unmatched: true,
          image_warning: imageAnalysis.warningItem || 'Warning: Uploaded image does not match selected pet profile.',
          image_result_status: imageAnalysis.image_result_status || 'not_available',
          condition_likelihood: 'Not available',
          conditionLikelihood: 'Not available'
        };
      }

      const chosenUrgency = urgencyRank(imageUrgency) >= urgencyRank(symptomUrgency) ? imageUrgency : symptomUrgency;

      return {
        ...symptomAnalysis,
        diagnosis: uniqueList([...symptomDiagnosis, ...imageDiagnosis]),
        possible_causes: uniqueList([...symptomCauses, ...imageCauses]),
        recommendation: [symptomRecommendation, imageRecommendation].filter(Boolean).join(' '),
        urgency_level: chosenUrgency || 'Unknown',
        image_findings: imageDiagnosis,
        image_unmatched: false,
        image_warning: imageAnalysis.warningItem || '',
        image_result_status: imageAnalysis.image_result_status || 'available'
      };
    }

    function buildCareGuidance(analysis) {
      const urgency = String(analysis.urgency_level || 'Unknown').toLowerCase();
      const selectedSymptoms = Array.from(document.querySelectorAll('.symptom-item input:checked')).map(i => i.value).filter(Boolean);

      const homeCare = [];
      const monitor = [];
      const redFlags = [];

      homeCare.push('Keep fresh water available at all times and monitor hydration.');
      homeCare.push('Provide rest in a quiet, low-stress environment.');
      homeCare.push('Offer small, bland meals unless vomiting is ongoing.');

      monitor.push('Track appetite, water intake, stool quality, and activity every 4-6 hours.');
      monitor.push('Watch for worsening skin redness, swelling, discharge, or pain.');
      monitor.push('Take a follow-up photo in similar lighting to compare progression.');

      if (selectedSymptoms.includes('vomiting') || selectedSymptoms.includes('diarrhea')) {
        homeCare.push('Use a bland diet and avoid sudden food changes for 24-48 hours.');
        monitor.push('Check for dehydration signs such as dry gums or lethargy.');
        redFlags.push('Repeated vomiting, blood in stool, or inability to keep water down.');
      }
      if (selectedSymptoms.includes('labored breathing') || selectedSymptoms.includes('coughing')) {
        redFlags.push('Rapid breathing, open-mouth breathing, or bluish gums.');
      }
      if (selectedSymptoms.includes('lethargy')) {
        redFlags.push('Extreme weakness, collapse, or no response to interaction.');
      }

      if (urgency === 'high' || urgency === 'emergency') {
        redFlags.push('Urgency is high: seek same-day veterinary care.');
      } else if (urgency === 'medium' || urgency === 'moderate') {
        monitor.push('If no clear improvement in 12-24 hours, schedule a vet visit.');
      } else {
        monitor.push('If symptoms persist beyond 24-48 hours, consult your vet.');
      }

      return {
        homeCare: uniqueList(homeCare),
        monitor: uniqueList(monitor),
        redFlags: uniqueList(redFlags)
      };
    }

    function renderResults(analysis) {
      const resultsContent = document.getElementById('resultsContent');
      const diagnosis = Array.isArray(analysis.diagnosis) ? analysis.diagnosis : (analysis.diagnosis ? [analysis.diagnosis] : ['Not available']);
      const recommendation = analysis.recommendation || 'Not available';
      const urgencyLevel = analysis.urgency_level || 'Unknown';
      const causes = Array.isArray(analysis.possible_causes) ? analysis.possible_causes : (analysis.possible_causes ? [analysis.possible_causes] : ['Not available']);
      const nextSteps = Array.isArray(analysis.next_steps) ? analysis.next_steps : (analysis.next_steps ? [analysis.next_steps] : []);
      const homeCare = Array.isArray(analysis.home_care) ? analysis.home_care : (analysis.home_care ? [analysis.home_care] : []);
      const redFlags = Array.isArray(analysis.red_flags) ? analysis.red_flags : (analysis.red_flags ? [analysis.red_flags] : []);
      const imageFindings = Array.isArray(analysis.image_findings) ? analysis.image_findings : (analysis.image_findings ? [analysis.image_findings] : []);
      const imageUnmatched = analysis.image_unmatched === true || String(analysis.image_result_status || '').toLowerCase() === 'not_available';
      const imageWarning = analysis.image_warning || analysis.warningItem || '';
      const guidance = buildCareGuidance(analysis);
      latestGuidance = guidance;
      const urgencyColor = { Low:'success', Medium:'warning', High:'danger', Emergency:'danger' }[urgencyLevel] || 'secondary';
      const recommendationTone = imageUnmatched ? 'warn' : (urgencyRank(urgencyLevel) >= 3 ? 'danger' : (urgencyRank(urgencyLevel) >= 2 ? 'warn' : 'safe'));
      const recommendationText = imageUnmatched
        ? 'Image-based result: Not available because the uploaded image does not match the selected pet profile. Please upload a clear photo of the selected pet.'
        : recommendation;
      const homeItems = (homeCare.length ? homeCare : guidance.homeCare);
      const redItems = (redFlags.length ? redFlags : guidance.redFlags);

      const preview = document.getElementById('imagePreview');
      const imageSrc = analysisImageUrl ? `/${analysisImageUrl}` : ((preview && !preview.classList.contains('d-none')) ? preview.src : '');
      const showImageAnalysisCard = Boolean(imageSrc);
      const imageFindingRows = imageUnmatched
        ? ['Not available: uploaded image does not match selected pet profile.']
        : (imageFindings.length ? imageFindings : ['Not available']);
      const imageBlock = imageSrc
        ? `<div class="result-card mb-3"><div class="section-title"><span class="logo-dot"><i class="fas fa-image"></i></span><h6 class="mb-0">Uploaded Image</h6></div><img src="${imageSrc}" class="img-fluid result-image"></div>`
        : '';

      resultsContent.innerHTML = `
        ${imageUnmatched ? `<div class="result-warning"><i class="fas fa-triangle-exclamation me-2"></i>${imageWarning || 'Warning: Uploaded image does not match the selected pet profile. Image-based result is not available.'}</div>` : ''}
        <div class="results-hero">
          <div class="hero-title">Diagnostic Analysis Complete</div>
          <div class="text-muted small">${imageUnmatched ? 'AI processed symptoms. Image-based assessment is unavailable due to pet-image mismatch.' : 'AI has processed symptoms and visual context to create a clear care summary.'}</div>
          <div class="metric-row">
            <span class="metric-pill"><i class="fas fa-heart-pulse text-danger"></i> Urgency: <strong>${urgencyLevel}</strong></span>
            <span class="metric-pill"><i class="fas fa-stethoscope text-primary"></i> Findings: <strong>${diagnosis.length}</strong></span>
            <span class="metric-pill"><i class="fas fa-triangle-exclamation text-warning"></i> Causes: <strong>${causes.length}</strong></span>
          </div>
        </div>
        <div class="result-layout">
          <div>
            ${imageBlock}
            <div class="top-duo">
              <div class="result-card">
                <div class="section-title"><span class="logo-dot"><i class="fas fa-diagnoses"></i></span><h6 class="mb-0">Preliminary Diagnosis</h6></div>
                <ul class="mb-0">${diagnosis.map(d => `<li>${d}</li>`).join('')}</ul>
              </div>
              <div class="result-card">
                <div class="section-title"><span class="logo-dot"><i class="fas fa-lightbulb"></i></span><h6 class="mb-0">Possible Causes</h6></div>
                <ul class="mb-0">${causes.map(c => `<li>${c}</li>`).join('')}</ul>
              </div>
            </div>
            <div class="result-card mt-3">
              <div class="section-title"><span class="logo-dot"><i class="fas fa-exclamation-triangle"></i></span><h6 class="mb-0">Urgency Level</h6></div>
              <span class="badge bg-${urgencyColor} fs-6">${urgencyLevel}</span>
            </div>
            <div class="result-card mt-3">
              <div class="section-title"><span class="logo-dot"><i class="fas fa-clipboard-list"></i></span><h6 class="mb-0">Recommendations</h6></div>
              <div class="recommendation-box ${recommendationTone}">${recommendationText}</div>
            </div>
            <div class="result-card mt-3">
              <div class="section-title"><span class="logo-dot"><i class="fas fa-notes-medical"></i></span><h6 class="mb-0">Brief Analysis</h6></div>
              <p class="mb-2 text-muted">Based on symptom inputs${(!imageUnmatched && imageFindings.length) ? ' and uploaded image findings' : ''}, the AI detected <strong>${diagnosis.length}</strong> primary indicator(s) with a current urgency of <strong>${urgencyLevel}</strong>.</p>
              <p class="mb-0 text-muted">Focus on hydration, appetite, behavior changes, and symptom progression over the next 12-24 hours. Escalate quickly if red-flag signs appear.</p>
            </div>
            <div class="result-grid mt-3">
              ${showImageAnalysisCard ? `
              <div class="result-card">
                <div class="section-title"><span class="logo-dot"><i class="fas fa-camera"></i></span><h6 class="mb-0">Image AI Findings</h6></div>
                <ul>${imageFindingRows.map(s => `<li>${s}</li>`).join('')}</ul>
              </div>` : ''}
              <div class="result-card">
                <div class="section-title"><span class="logo-dot"><i class="fas fa-house-medical"></i></span><h6 class="mb-0">Home Care</h6></div>
                <ul>${homeItems.map(s => `<li>${s}</li>`).join('')}</ul>
              </div>
              <div class="result-card">
                <div class="section-title"><span class="logo-dot"><i class="fas fa-eye"></i></span><h6 class="mb-0">What To Monitor</h6></div>
                <ul>${guidance.monitor.map(s => `<li>${s}</li>`).join('')}</ul>
              </div>
              ${nextSteps.length ? `
              <div class="result-card">
                <div class="section-title"><span class="logo-dot"><i class="fas fa-list-check"></i></span><h6 class="mb-0">Next Steps</h6></div>
                <ul>${nextSteps.map(s => `<li>${s}</li>`).join('')}</ul>
              </div>` : ''}
            </div>
            <div class="result-card mt-3">
              <div class="section-title"><span class="logo-dot"><i class="fas fa-triangle-exclamation"></i></span><h6 class="mb-0">When To Seek Immediate Vet Care</h6></div>
              <ul>${redItems.map(s => `<li>${s}</li>`).join('')}</ul>
            </div>
          </div>
          <aside class="result-rail">
            <div class="action-card">
              <div class="section-title"><span class="logo-dot"><i class="fas fa-chart-line"></i></span><h6 class="mb-0">Assessment Snapshot</h6></div>
              <div class="mini-grid">
                <div class="mini-pill">
                  <div class="mini-label">Urgency</div>
                  <div class="mini-value">${urgencyLevel}</div>
                </div>
                <div class="mini-pill">
                  <div class="mini-label">Findings</div>
                  <div class="mini-value">${diagnosis.length}</div>
                </div>
                <div class="mini-pill">
                  <div class="mini-label">Causes</div>
                  <div class="mini-value">${causes.length}</div>
                </div>
                <div class="mini-pill">
                  <div class="mini-label">Image Input</div>
                  <div class="mini-value">${imageSrc ? (imageUnmatched ? 'Mismatch' : 'Matched') : 'No'}</div>
                </div>
              </div>
            </div>

            <div class="action-card">
              <div class="section-title"><span class="logo-dot"><i class="fas fa-shield-heart"></i></span><h6 class="mb-0">Report Actions</h6></div>
              <p class="text-muted small mb-3">Save this report to health records or export a PDF summary.</p>
              <button type="button" class="btn btn-primary action-btn" onclick="saveAssessmentResult()"><i class="fas fa-floppy-disk me-2"></i>Save to Health Record</button>
              <button type="button" class="btn btn-outline-primary action-btn" onclick="downloadAssessmentPDF()"><i class="fas fa-file-pdf me-2"></i>Download PDF Summary</button>
              <button type="button" class="btn btn-outline-secondary action-btn" onclick="window.print()"><i class="fas fa-print me-2"></i>Print Report</button>
            </div>

            <div class="action-card">
              <div class="section-title"><span class="logo-dot"><i class="fas fa-clock"></i></span><h6 class="mb-0">Next 24 Hours</h6></div>
              <ul class="mb-0">
                <li>Follow <strong>${Math.min(2, homeItems.length)}</strong> key home-care steps first.</li>
                <li>Monitor behavior and intake every 4-6 hours.</li>
                <li>${redItems.length ? redItems[0] : 'Seek care if symptoms worsen quickly.'}</li>
              </ul>
            </div>
          </aside>
        </div>
      `;
    }

    function buildExportPayload() {
      return {
        pet_id: Number(getSelectedPetId()),
        symptoms: buildSymptomsText(),
        analysis: {
          ...(analysisPayload || {}),
          home_care: (analysisPayload && Array.isArray(analysisPayload.home_care) && analysisPayload.home_care.length)
            ? analysisPayload.home_care
            : latestGuidance.homeCare,
          red_flags: (analysisPayload && Array.isArray(analysisPayload.red_flags) && analysisPayload.red_flags.length)
            ? analysisPayload.red_flags
            : latestGuidance.redFlags,
          monitor_items: latestGuidance.monitor
        }
      };
    }

    async function saveAssessmentResult() {
      try {
        const petId = getSelectedPetId();
        if (!petId || !analysisPayload) return showNotification('No assessment available to save', 'warning');
        const response = await fetch('/api/save_assessment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(buildExportPayload())
        });
        const data = await response.json();
        if (!response.ok || !data.success) throw new Error(data.error || 'Failed to save assessment');
        showNotification('Assessment saved to health records', 'success');
      } catch (err) {
        showNotification('Save failed: ' + err.message, 'error');
      }
    }

    async function downloadAssessmentPDF() {
      try {
        const petId = getSelectedPetId();
        if (!petId || !analysisPayload) return showNotification('No assessment available for PDF export', 'warning');
        const response = await fetch('/api/export_assessment_pdf', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(buildExportPayload())
        });
        if (!response.ok) {
          const err = await response.json().catch(() => ({}));
          throw new Error(err.error || 'Failed to generate PDF');
        }
        const blob = await response.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'assessment_summary.pdf';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch (err) {
        showNotification('PDF export failed: ' + err.message, 'error');
      }
    }

    function restartWizard() {
      document.getElementById('symptomForm').reset();
      document.getElementById('selectedPetId').value = '';
      document.querySelectorAll('#petCards .pet-card').forEach(c => c.classList.remove('active'));
      document.querySelectorAll('.symptom-item input').forEach(i => i.checked = false);
      const preview = document.getElementById('imagePreview');
      const text = document.getElementById('dropText');
      if (preview) { preview.classList.add('d-none'); preview.src = ''; }
      if (text) text.classList.remove('d-none');
      uploadedImageFile = null;
      setStep(1);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function startConsultation() {
      const petId = getSelectedPetId();
      if (petId) {
        window.location.href = `/consultation/${petId}`;
      } else {
        showNotification('Please select a pet first', 'warning');
      }
    }

    function showNotification(message, type) {
      const host = document.getElementById('notifyHost');
      if (!host) return;
      const bsType = type === 'error' ? 'danger' : (type === 'warning' ? 'warning' : 'success');
      const node = document.createElement('div');
      node.className = `alert alert-${bsType} shadow-sm border-0`;
      node.role = 'alert';
      node.textContent = message;
      host.appendChild(node);
      setTimeout(() => {
        node.classList.add('opacity-0');
        setTimeout(() => node.remove(), 250);
      }, 2800);
    }
  </script>
</body>

</html>
